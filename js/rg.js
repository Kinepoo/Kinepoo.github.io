function e(){var e={};return e.position=vec3.create(),e.rotation=quat.create(),quat.identity(e.rotation),e.scale=[1,1,1],e.addPosition=function(t){vec3.add(e.position,e.position,t)},e}function t(e,t,r){var n={},a=o(e,t),i=o(e,r);return n.id=e.createProgram(),e.attachShader(n.id,a),e.attachShader(n.id,i),e.linkProgram(n.id),e.getProgramParameter(n.id,e.LINK_STATUS)||alert("Could not initialise shaders"),n.shaderAttributes={},n.uniforms={},n.addUniform=function(t){e.useProgram(n.id),n.uniforms[t]=e.getUniformLocation(n.id,t)},n.getUniform=function(e){return n.uniforms[e]},n.addAttribute=function(t){e.useProgram(n.id),n.shaderAttributes[t]=e.getAttribLocation(n.id,t)},n.getAttribute=function(e){return n.shaderAttributes[e]},n.enableVertexAttributeArray=function(t){e.useProgram(n.id),e.enableVertexAttribArray(t)},n.bufferMatrix=function(t,o){e.useProgram(n.id),e.uniformMatrix4fv(n.getUniform(t),!1,o)},n.bufferVec2=function(t,o){e.useProgram(n.id),e.uniform2fv(n.getUniform(t),o)},n}function o(e,t){var o=document.getElementById(t);if(!o)return null;for(var r="",n=o.firstChild;n;)3==n.nodeType&&(r+=n.textContent),n=n.nextSibling;var a;if("x-shader/x-fragment"==o.type)a=e.createShader(e.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=o.type)return null;a=e.createShader(e.VERTEX_SHADER)}return e.shaderSource(a,r),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)?a:(alert(e.getShaderInfoLog(a)),null)}function r(e){var t={};return t.id=e.createBuffer(),console.log("Created Buffer "+t.id),t.bufferFloats=function(o){console.log("Buffer data "+o),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW)},t}function n(e,t){var o={};return o.useTexture=null!=t,o.readyTexture=!1,o.createModel=function(){var t={},o=[1,1,-1,1,-1,-1,-1,-1,1,-1,1,1];return t.id=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),t},o.render=function(t){o.useTexture&&!o.readyTexture||(e.useProgram(t.id),o.useTexture&&e.bindTexture(e.TEXTURE_2D,o.texID),e.bindBuffer(e.ARRAY_BUFFER,o.model.id),e.vertexAttribPointer(t.getAttribute("vertexPosition"),2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.bindBuffer(e.ARRAY_BUFFER,null))},o.loadTexture=function(){o.image=new Image,o.image.onload=function(){o.texID=e.createTexture(),e.bindTexture(e.TEXTURE_2D,o.texID),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o.image),e.generateMipmap(e.TEXTURE_2D),o.readyTexture=!0,console.log("Ready texture: "+t)},o.image.src=t},o.model=o.createModel(),o.useTexture&&o.loadTexture(),o}function a(e,t,o){var r={};return r.loadedImages=0,r.blocks={},r.createModel=function(){var t={},o=[0,0,1,0,0,1,0,1,1,0,1,1];t.id=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),t.coordId=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.coordId),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),t.vaoId=e.createVertexArray(),e.bindVertexArray(t.vaoId);e.enableVertexAttribArray(I.getAttribute("vertexPosition")),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,null);return e.enableVertexAttribArray(I.getAttribute("textureCoordinates")),e.bindBuffer(e.ARRAY_BUFFER,t.coordId),e.vertexAttribPointer(1,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindVertexArray(null),t},r.render=function(t){r.loadedImages<1||(e.useProgram(t.id),e.bindVertexArray(r.model.vaoId),e.uniform1i(t.getUniform("colorMap"),0),e.uniform1i(t.getUniform("blockMap"),1),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D_ARRAY,U.images.blocks.imageId),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r.blockId),e.bindBuffer(e.ARRAY_BUFFER,r.model.id),e.vertexAttribPointer(t.getAttribute("vertexPosition"),2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,r.model.coordId),e.vertexAttribPointer(t.getAttribute("textureCoordinates"),2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindVertexArray(null),e.activeTexture(e.TEXTURE0))},r.loadBlockTexture=function(){r.blockImage=new Image,r.blockImage.onload=function(){r.blockId=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.blockId),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r.blockImage),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),console.log("Ready texture2: "+o),r.loadedImages++},r.blockImage.src=o},r.createBlockTexture=function(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(e){console.log("loaded BlockShip");var o=U.protoDefinition.Mass,n=new Uint8Array(t.response),a=o.decode(n);r.setupFromProtobuf(a),console.log(a)},t.send(null)},r.createFramebuffer=function(){},r.getHash=function(e,t){return 522133279*e^t},r.setupFromProtobuf=function(e){var t=e.blocks;if(t)for(var o=t.length-1;o>=0;o--){var n=t[o],a=(n.type,n.x||0);n.x=a;var i=n.y||0;n.y=i;var c=r.getHash(a,i);r.blocks[c]=n}console.log(r.blocks)},r.loadBlockTexture(),r.model=r.createModel(),r}function i(e){var t={};return t.readyGeometry=!1,t.readyTextures=!1,t.model=function(o){var r={};return r.coordsBuffer=e.createBuffer(),r.indexBuffer=e.createBuffer(),r.count=o.indices.length,e.bindBuffer(e.ARRAY_BUFFER,r.coordsBuffer),e.bufferData(e.ARRAY_BUFFER,o.vertexPositions,e.STATIC_DRAW),console.log("buffer vertices: "+o.vertexPositions.length),console.log("buffer indecies: "+o.indices.length),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,o.indices,e.STATIC_DRAW),t.readyGeometry=!0,r.render=function(){e.drawElements(e.TRIANGLES,r.count,e.UNSIGNED_SHORT,0)},r}(cube(50)),function(o){for(var r=0,n=new Array(6),a=0;a<6;a++)n[a]=new Image,n[a].onload=function(){if(6==++r){t.texID=e.createTexture(),e.bindTexture(e.TEXTURE_CUBE_MAP,t.texID);for(var o=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z],a=0;a<6;a++)e.texImage2D(o[a],0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n[a]),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.generateMipmap(e.TEXTURE_CUBE_MAP),t.readyTextures=!0,console.log("Ready textures")}},n[a].src=o[a]}(["images/skyposx1.png","images/skynegx1.png","images/skyposy1.png","images/skynegy1.png","images/skyposz1.png","images/skynegz1.png"]),t.render=function(o){if(t.readyTextures&&t.readyGeometry){e.useProgram(o.id),e.bindTexture(e.TEXTURE_CUBE_MAP,t.texID),e.bindBuffer(e.ARRAY_BUFFER,t.model.coordsBuffer),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.model.indexBuffer),e.vertexAttribPointer(o.getAttribute("coords"),3,e.FLOAT,!1,0,0);var r=mat4.create();mat4.fromQuat(r,k.transform.rotation),o.bufferMatrix("modelview",r),t.model.render()}else console.log("Not yet ready")},t}function c(){var e={};return e.locked=!1,v.addEventListener("mousemove",function(t){if(e.locked){var o=t.movementX||t.mozMovementX||t.webkitMovementX||0,r=t.movementY||t.mozMovementY||t.webkitMovementY||0,n=.05*o;k.yaw+=n;a=.05*r;k.pitch+=a,k.pitch>90?k.pitch=90:k.pitch<-90&&(k.pitch=-90);var a=quat.create();quat.setAxisAngle(a,[1,0,0],glMatrix.toRadian(k.pitch));n=quat.create();quat.setAxisAngle(n,[0,1,0],glMatrix.toRadian(k.yaw));var i=quat.create();quat.mul(i,a,n),quat.normalize(i,i),quat.copy(k.transform.rotation,i)}else;},!1),document.addEventListener("pointerlockchange",function(t){console.log("pointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("mozpointerlockchange",function(t){console.log("mozpointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("webkitpointerlockchange",function(t){console.log("webkitpointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("pointerlockerror",function(e){console.log("pointerlockerror "+e)},!1),document.addEventListener("mozpointerlockerror",function(e){console.log("mozpointerlockerror "+e)},!1),document.addEventListener("webkitpointerlockerror",function(e){console.log("webkitpointerlockerror "+e)},!1),v.addEventListener("click",function(t){console.log("Clicked on canvas, trying to lock"),!e.locked&&e.canLock()&&e.lock()},!1),e.update=function(){},e.canLock=function(){var e="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;return console.log("Can mouse lock: "+e),e},e.lock=function(){console.log("Trying to lock"),v.requestPointerLock=v.requestPointerLock||v.mozRequestPointerLock||v.webkitRequestPointerLock,v.requestPointerLock()},e.unlock=function(){console.log("Trying to unlock"),document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()},e.onLockChanged=function(t){document.pointerLockElement===v||document.mozPointerLockElement===v||document.webkitPointerLockElement===v?(console.log("enabled lock"),e.locked=!0):(console.log("disabled lock"),e.locked=!1)},e}function d(e,t){var o=e.getBoundingClientRect();return{x:t.clientX-o.left,y:t.clientY-o.top}}function u(){var e={};return document.onkeydown=s,document.onkeyup=f,e.update=function(){var e=vec3.create(),t=vec3.create(),o=quat.create();quat.invert(o,k.transform.rotation),vec3.transformQuat(t,[0,0,1],o),quat.copy(e,t);var r=0;r+=l("W")?1:0,r-=l("S")?1:0,e[1]=0,vec3.normalize(e,e),vec3.scale(e,e,.1*r),k.transform.addPosition(e);var n=vec3.create();vec3.cross(n,t,[0,1,0]);var a=0;a+=l("D")?1:0,a-=l("A")?1:0,n[1]=0,vec3.normalize(n,n),vec3.scale(n,n,.1*a),k.transform.addPosition(n)},e}function l(e){return!!x[e]&&1==x[e]}function s(e){x[String.fromCharCode(e.keyCode)]=!0}function f(e){x[String.fromCharCode(e.keyCode)]=!1}function E(){var t={};return t.projectionMatrix=mat4.create(),t.transform=e(),t.yaw=0,t.pitch=0,t.perspective=function(e,o,r,n){mat4.perspective(t.projectionMatrix,e,o,r,n)},t.orthographic=function(e,o,r,n,a,i){mat4.ortho(t.projectionMatrix,e,o,r,n,a,i),console.log("setup orthographic")},t}function m(e){var t=new WebSocket(e);return t.binaryType="arraybuffer",t.onopen=function(e){console.log("On connected")},t.onmessage=function(e){console.log("Got message "+e+" "+e.data+" "+e.data.byteLength),console.log(e.data);var t=new Uint8Array(e.data),o=U.protoDefinition.Base.decode(t);console.log(o)},t.send=function(e){var o=U.protoDefinition.Base,r=o.verify(e);if(r)throw Error(r);var n=o.create(e),a=o.encode(n).finish();console.log("Sending "+a.byteLength+" bytes"),t.send(a)},t}function T(e){U.protoDefinition={},U.images={};var t={};return t.nextId=1,t.queue=[],t.createLoader=function(e){var o={};return o.done=!1,o.id=t.nextId,t.nextId++,o.loadFunc=e,o},t.loadAll=function(){for(var e=t.queue.length-1;e>=0;e--)t.queue[e].loadFunc()},t.loadTexture=function(e,o,r,n,a){var i=t.createLoader(function(){var c=new Image;U.images[o]={},U.images[o].image=c,c.onload=function(){var e=p.createTexture();U.images[o].imageId=e,p.bindTexture(p.TEXTURE_2D,e),p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,c),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,r),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,n),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),a&&p.generateMipmap(p.TEXTURE_2D),console.log("Ready texture: "+blockMapName),t.onCompleteDownload(i)},c.src=e});t.queue.push(i)},t.loadTextureArray=function(e,o){var r=t.createLoader(function(){var n=new Image;U.images[o]={},U.images[o].image=n,n.onload=function(){var a=p.createTexture();U.images[o].imageId=a;var i=document.createElement("canvas");i.width=1024,i.height=1024;var c=i.getContext("2d");c.drawImage(n,0,0),p.activeTexture(p.TEXTURE0),p.bindTexture(p.TEXTURE_2D_ARRAY,a),p.texParameteri(p.TEXTURE_2D_ARRAY,p.TEXTURE_MIN_FILTER,p.LINEAR_MIPMAP_LINEAR),p.texParameteri(p.TEXTURE_2D_ARRAY,p.TEXTURE_MAG_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_2D_ARRAY,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D_ARRAY,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);for(var d=new Uint8Array(4194304),u=0;u<16;u++)for(var l=0;l<16;l++)for(var s=16*u+l,f=c.getImageData(64*l,64*u,64,64),E=new Uint8Array(f.data.buffer),m=0;m<16384;m++)d[16384*s+m]=E[m];p.texImage3D(p.TEXTURE_2D_ARRAY,0,p.RGBA,64,64,256,0,p.RGBA,p.UNSIGNED_BYTE,d),p.generateMipmap(p.TEXTURE_2D_ARRAY),console.log("Ready texture array: "+e),t.onCompleteDownload(r)},n.src=e});t.queue.push(r)},t.loadProtobufDefinition=function(e,o){var r=t.createLoader(function(){console.log("AssetLoader: starting protobuf "+e),protobuf.load(e,function(n,a){if(console.log("AssetLoader: loaded protobuf "+e),n)throw n;U.protoDefinition[o]=a.lookupType(o),t.onCompleteDownload(r)})});t.queue.push(r)},t.loadAudioAsset=function(e){},t.onCompleteDownload=function(o){for(var r=t.queue.length-1;r>=0;r--)t.queue[r].id==o.id&&(t.queue.splice(r,1),console.log("Removed asset "+r));t.queue.length<=0&&(console.log("assets loaded!"),e())},t}function main(){v=document.getElementById("webcanvas"),g(),U.loader=T(A),U.loader.loadProtobufDefinition("proto/WebsocketProto.proto","Base"),U.loader.loadProtobufDefinition("proto/BlockShip.proto","Mass"),U.loader.loadTextureArray("images/blocks.png","blocks"),U.loader.loadAll()}function A(){console.log("ready!"),F=c(),L=u(),console.log("Loaded shaders"),(k=E()).perspective(45,4/3,.1,100),(B=t(p,"shader-vs","shader-fs")).addAttribute("aVertexPosition"),B.enableVertexAttributeArray(B.getAttribute("aVertexPosition")),B.addUniform("uPMatrix"),B.addUniform("uMVMatrix"),(y=t(p,"skyboxVertexShader","skyboxFragmentShader")).addAttribute("coords"),y.enableVertexAttributeArray(y.getAttribute("coords")),y.addUniform("modelview"),y.addUniform("projection"),y.bufferMatrix("projection",k.projectionMatrix),(h=t(p,"quadVertexShader","quadFragmentShader")).addAttribute("vertexPosition"),h.addUniform("modelview"),h.addUniform("projection"),h.enableVertexAttributeArray(h.getAttribute("vertexPosition")),h.bufferMatrix("projection",k.projectionMatrix),(I=t(p,"blockVertexShader","blockFragmentShader")).addAttribute("vertexPosition"),I.addAttribute("textureCoordinates"),I.addUniform("modelview"),I.addUniform("projection"),I.addUniform("colorMap"),I.addUniform("blockMap"),I.addUniform("blockMapDimensions"),I.bufferMatrix("projection",k.projectionMatrix),I.bufferVec2("blockMapDimensions",[4,4]),X=n(p,"images/llama.png"),(C=a(p,"images/ss4.png","ships/testShip.png")).createBlockTexture("ships/ship.data");var e=C.getHash(0,0),o=C.getHash(1,0),d=C.getHash(0,0);console.log("Hashes "+e+" "+o+" "+d),console.log("Create camera"),M=i(p),console.log("Create skybox"),(P=r(p)).bufferFloats([0,1,0,-1,-1,0,1,-1,0]),p.clearColor(1,0,0,1),p.enable(p.DEPTH_TEST),setInterval(R,30)}function g(){try{(p=v.getContext("webgl2")).viewportWidth=v.width,p.viewportHeight=v.height,p.viewport(0,0,p.viewportWidth,p.viewportHeight),p.enable(p.BLEND),p.blendFunc(p.SRC_ALPHA,p.ONE_MINUS_SRC_ALPHA),console.log("WebGL loaded!")}catch(e){console.log("COuld not get webgl")}p||alert("Could not initialise WebGL, sorry :-( ")}function R(){_(),b()}function _(){F.update(),L.update()}function b(){D++,p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);var e=mat4.create(),t=mat4.create();mat4.fromTranslation(e,k.transform.position),mat4.fromQuat(t,k.transform.rotation),mat4.mul(S,t,e),M.render(y),mat4.translate(S,S,[-1.5,0,-7]),mat4.rotateX(S,S,3.14),I.bufferMatrix("modelview",S),C.render(I)}console.log("Prepared shaders");var x={},p,v,U={},k,P,B,y,h,I,D=0,F,L,M,X,C,S=mat4.create();