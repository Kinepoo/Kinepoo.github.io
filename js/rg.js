function e(){var e={};return e.position=vec3.create(),e.rotation=quat.create(),quat.identity(e.rotation),e.scale=[1,1,1],e.invPosition=vec3.create(),e.addPosition=function(t){vec3.add(e.position,e.position,t)},e.getNegativePosition=function(){return vec3.scale(e.invPosition,e.position,-1),e.invPosition},e}function t(e,t,r,o,n,i){var a={};return a.type=e,a.owner=t,a.position=[r,o],a.velocity=[n,i],a.update=function(){a.lifetimeLeft-=O.time.deltaTime},a.createRenderer=function(){if(1==e){a.renderer=A();var t=[r,o,n,i],s=[1,0,0,1,1,0,0,1];a.renderer.bufferPoints(t,s)}},a.render=function(){a.renderer&&a.renderer.render()},a.setLifetimeLeft=function(){a.lifetimeLeft=1==e?.25:0},a.canDamage=function(e){return e!=a.owner&&a.lifetimeLeft>0},a.shouldRemove=function(){return a.lifetimeLeft<=0},a.setLifetimeLeft(),a.createRenderer(),a}function r(e,r){var o={};return o.id=e,o.mainPlayerId=r,o.players=[],o.playerMap={},o.ships=[],o.shipMap={},o.projectiles=[],console.log("Created hotspot "+e+" myId "+r),o.createLocalPlayer=function(){console.log("Create local player"),o.mainPlayer=g(),o.mainPlayer.id=r,o.mainPlayer.mainPlayer=!0,o.mainPlayer.setFrame(0),o.players.push(o.mainPlayer),o.playerMap[r]=o.mainPlayer},o.createPlayer=function(e){var t=e.identity;console.log("Create player "+t);var r=g();r.id=t,r.setFrame(0),o.players.push(r),o.playerMap[t]=r},o.removePlayer=function(e){console.log("remove player"),console.log(e)},o.getPlayer=function(e){return o.playerMap[e]},o.getMainPlayer=function(){return o.getPlayer(o.mainPlayerId)},o.getMainPlayerId=function(){return o.mainPlayerId},o.createShip=function(e){var t=e.identity;console.log("Create ship "+t);var r=c();r.loadFromBytes(e.ship);var n=p(r);n.id=t,o.ships.push(n),o.shipMap[t]=n},o.removeShip=function(e){console.log("remove ship"),console.log(e)},o.getShip=function(e){return o.shipMap[e]},o.updatePlayerTransform=function(e){var t=o.playerMap[e.identity];t?t.updateTransform(e):console.log("Hotspot ERROR: could not find player "+e.identity)},o.updateShipTransform=function(e){var t=o.getShip(e.identity);if(t){var r=e.x||0,n=e.y||0,i=e.vx||0,a=e.vy||0;t.transform.position[0],t.transform.position[1];vec3.set(t.transform.position,r,n,0),t.velocity[0]=i,t.velocity[1]=a}else console.log("Hotspot ERROR: could not find ship "+e.identity)},o.update=function(){for(e=o.ships.length-1;e>=0;e--)o.ships[e].update();for(e=o.players.length-1;e>=0;e--)o.players[e].update();for(var e=o.projectiles.length-1;e>=0;e--)o.projectiles[e].update(),o.projectiles[e].shouldRemove()&&o.projectiles.splice(e,1)},o.moveMainPlayer=function(e,t){o.mainPlayer.move(e,t)},o.render=function(){O.backgroundSprite.renderScreenSpaceUvOffset();for(e=o.ships.length-1;e>=0;e--)o.ships[e].blockRenderer.render(H);for(e=o.players.length-1;e>=0;e--)o.players[e].render();for(var e=o.projectiles.length-1;e>=0;e--)o.projectiles[e].render()},o.createProjectile=function(e,r,n,i,a,s){var d=t(r,e,n,i,a,s);o.projectiles.push(d)},o.createLocalPlayer(),o}function o(){var e={};return e.type=2,e.stateRoot=0,e.stateHyperdrive=1,e.stateSave=2,e.stateLoad=3,e.state=0,e.inputText="",e.destinations=[],e.render=function(){if(e.state==e.stateRoot)O.hotspot,Q.renderTextAtScreen("-1- HYPERDRIVE",!0,0,16),Q.renderTextAtScreen("-2- SAVE",!0,0,8),Q.renderTextAtScreen("-3- LOAD",!0,0,0);else if(e.state==e.stateHyperdrive){var t=e.destinations.length;if(t>0){var r=8*t;Q.renderTextAtScreen("-ESC- Back",!0,0,16),Q.renderTextAtScreen("-Enter destination-",!0,0,8),e.inputText.length>0&&e.inputText.trim().length>0&&Q.renderTextAtScreen(e.inputText,!0,0,0);for(var o=0;o<e.destinations.length;o++){var n=e.destinations[o];Q.renderTextAtScreen(n.id+" "+n.name,!0,0,r-8*o+24)}}else Q.renderTextAtScreen("loading destinations..",!0,0,0)}},e.setState=function(t){e.state=t,t==e.stateHyperdrive&&(e.destinations.length<=0?(console.log("need to ask server for destinations"),O.socket.sendMsg({type:4})):console.log("has "+e.destinations.length+" destinations"))},e.addInput=function(t){e.inputText+=t},e.backspace=function(){e.inputText.length>0&&(e.inputText=e.inputText.substr(0,e.inputText.length-1))},e.onAccept=function(){var t=parseInt(e.inputText);isNaN(t)?console.log("Invalid input "+e.inputText):(console.log("Travelling to "+t),O.targetHotspot=t,O.socket.sendMsg({type:6,requestTravel:{targetDestination:t}}),e.state=0),e.inputText=""},e.handleKeyDown=function(t,r){e.state==e.stateRoot?49==r?(e.inputText="",e.setState(e.stateHyperdrive)):50==r?e.setState(e.stateSave):51==r&&e.setState(e.stateLoad):1==e.state?220==r?e.state=0:8==r?e.backspace():13==r?e.onAccept():e.addInput(t):220==r&&(e.state=e.stateRoot)},e.capturedInput=function(){return 1==e.state},e.onmessage=function(t){if(5==t.type){console.log("Got destinations!");for(var r=0;r<t.destinationResponse.destinationIds.length;r++)e.destinations.push({id:t.destinationResponse.destinationIds[r],name:t.destinationResponse.destinationNames[r],numberOfPlayers:t.destinationResponse.destinationPlayerCount[r]})}},e}function n(){var e={};return e.state=1,e.type=1,e.render=function(){1==e.state?Q.renderTextAtScreen("LOADING",!0,0,16):2==e.state&&Q.renderTextAtScreen("CONNECTING",!0,0,16)},e.capturedInput=function(){return!0},e.onmessage=function(e){var t=e.type;console.log("Loading UI got message "+t)},e}function i(e,t,r){var o={},n=a(e,t),i=a(e,r);return o.id=e.createProgram(),e.attachShader(o.id,n),e.attachShader(o.id,i),e.linkProgram(o.id),e.getProgramParameter(o.id,e.LINK_STATUS)||alert("Could not initialise shaders"),o.shaderAttributes={},o.uniforms={},o.addUniform=function(t){e.useProgram(o.id),o.uniforms[t]=e.getUniformLocation(o.id,t)},o.getUniform=function(e){return o.uniforms[e]},o.addAttribute=function(t){e.useProgram(o.id),o.shaderAttributes[t]=e.getAttribLocation(o.id,t)},o.getAttribute=function(e){return o.shaderAttributes[e]},o.enableVertexAttributeArray=function(t){e.useProgram(o.id),e.enableVertexAttribArray(t)},o.bufferMatrix=function(t,r){e.useProgram(o.id),e.uniformMatrix4fv(o.getUniform(t),!1,r)},o.bufferVec2=function(t,r){e.useProgram(o.id),e.uniform2fv(o.getUniform(t),r)},o}function a(e,t){var r=document.getElementById(t);if(!r)return null;for(var o="",n=r.firstChild;n;)3==n.nodeType&&(o+=n.textContent),n=n.nextSibling;var i;if("x-shader/x-fragment"==r.type)i=e.createShader(e.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=r.type)return null;i=e.createShader(e.VERTEX_SHADER)}return e.shaderSource(i,o),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(alert(e.getShaderInfoLog(i)),null)}function s(e){var t={};return t.id=e.createBuffer(),console.log("Created Buffer "+t.id),t.bufferFloats=function(r){console.log("Buffer data "+r),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW)},t}function d(t,r){var o={};return o.transform=e(),console.log(t),console.log("Creating sprite"),o.createModel=function(){var e={},t=.5;r&&(t=r),e.vaoId=X.createVertexArray();var n=[-t,-t,t,-t,-t,t,-t,t,t,-t,t,t],i=[0,0,1,0,0,1,0,1,1,0,1,1];e.vertexPositionId=X.createBuffer(),e.uvsPositionId=X.createBuffer(),X.bindVertexArray(e.vaoId);X.enableVertexAttribArray(q.getAttribute("vertexPosition")),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(n),X.STATIC_DRAW),X.vertexAttribPointer(0,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null);return X.enableVertexAttribArray(q.getAttribute("textureCoordinates")),X.bindBuffer(X.ARRAY_BUFFER,e.uvsPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(i),X.STATIC_DRAW),X.vertexAttribPointer(1,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null),console.log(o),e},o.setTilesheetUv=function(e,r,n){var i=r/t.image.width,a=n/t.image.height,s=Math.floor(t.image.width/r),d=e%s,u=Math.floor(e/s),c=d*i,l=(d+1)*i,f=u*a,m=(u+1)*a,h=[c,f,l,f,c,m,c,m,l,f,l,m];X.bindBuffer(X.ARRAY_BUFFER,o.model.uvsPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(h),X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,null)},o.render=function(){var e=W.getViewMatrix(),r=o.transform.position;mat4.translate(e,e,r),q.bufferMatrix("modelview",e),X.useProgram(q.id),X.bindVertexArray(o.model.vaoId),X.uniform1i(q.getUniform("colorMap"),0),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D,t.imageId),X.bindBuffer(X.ARRAY_BUFFER,o.model.vertexPositionId),X.vertexAttribPointer(q.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,o.model.uvsPositionId),X.vertexAttribPointer(q.getAttribute("textureCoordinates"),2,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,6),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},o.renderScreenSpace=function(){var e=mat4.create();mat4.ortho(e,-256,256,256,-256,.1,100),q.bufferMatrix("projection",e);var r=mat4.create();mat4.fromTranslation(r,[0,0,-1]),q.bufferMatrix("modelview",r),X.useProgram(q.id),X.bindVertexArray(o.model.vaoId),X.uniform1i(q.getUniform("colorMap"),0),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D,t.imageId),X.bindBuffer(X.ARRAY_BUFFER,o.model.vertexPositionId),X.vertexAttribPointer(q.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,o.model.uvsPositionId),X.vertexAttribPointer(q.getAttribute("textureCoordinates"),2,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,6),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null),q.bufferMatrix("projection",W.projectionMatrix)},o.renderScreenSpaceUvOffset=function(){var e=W.transform.position,r=mat4.create();mat4.ortho(r,-256,256,256,-256,.1,100),O.shaders.quadOffsetVertexShader.bufferMatrix("projection",r);var n=mat4.create();mat4.fromTranslation(n,[0,0,-1]),O.shaders.quadOffsetVertexShader.bufferMatrix("modelview",n),O.shaders.quadOffsetVertexShader.bufferVec2("uvOffset",[e[0]/100,e[1]/100]),X.useProgram(O.shaders.quadOffsetVertexShader.id),X.bindVertexArray(o.model.vaoId),X.uniform1i(O.shaders.quadOffsetVertexShader.getUniform("colorMap"),0),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D,t.imageId),X.bindBuffer(X.ARRAY_BUFFER,o.model.vertexPositionId),X.vertexAttribPointer(O.shaders.quadOffsetVertexShader.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,o.model.uvsPositionId),X.vertexAttribPointer(O.shaders.quadOffsetVertexShader.getAttribute("textureCoordinates"),2,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,6),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null),O.shaders.quadOffsetVertexShader.bufferMatrix("projection",W.projectionMatrix)},o.model=o.createModel(),o}function u(e,t){var r={};return r.useTexture=null!=t,r.readyTexture=!1,r.createModel=function(){var t={},r=[1,1,-1,1,-1,-1,-1,-1,1,-1,1,1];return t.id=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW),t},r.render=function(t){r.useTexture&&!r.readyTexture||(e.useProgram(t.id),r.useTexture&&e.bindTexture(e.TEXTURE_2D,r.texID),e.bindBuffer(e.ARRAY_BUFFER,r.model.id),e.vertexAttribPointer(t.getAttribute("vertexPosition"),2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.bindBuffer(e.ARRAY_BUFFER,null))},r.loadTexture=function(){r.image=new Image,r.image.onload=function(){r.texID=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.texID),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r.image),e.generateMipmap(e.TEXTURE_2D),r.readyTexture=!0,console.log("Ready texture: "+t)},r.image.src=t},r.model=r.createModel(),r.useTexture&&r.loadTexture(),r}function c(){var e={};e.name="",e.loadedImages=0,e.blockIndex=0,e.blocks={},e.blocksArray=[],e.width=0,e.height=0,e.minX=0,e.maxX=0,e.minY=0,e.maxY=0;var t=d(O.images.ui);return t.setTilesheetUv(0,64,64),e.createModel=function(){var t={},r=[.5*-e.textureWidth,.5*-e.textureHeight,.5*e.textureWidth,.5*-e.textureHeight,.5*-e.textureWidth,.5*e.textureHeight,.5*-e.textureWidth,.5*e.textureHeight,.5*e.textureWidth,.5*-e.textureHeight,.5*e.textureWidth,.5*e.textureHeight];t.id=X.createBuffer(),X.bindBuffer(X.ARRAY_BUFFER,t.id),X.bufferData(X.ARRAY_BUFFER,new Float32Array(r),X.STATIC_DRAW),t.coordId=X.createBuffer(),X.bindBuffer(X.ARRAY_BUFFER,t.coordId),X.bufferData(X.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),X.STATIC_DRAW),t.vaoId=X.createVertexArray(),X.bindVertexArray(t.vaoId);X.enableVertexAttribArray(H.getAttribute("vertexPosition")),X.bindBuffer(X.ARRAY_BUFFER,t.id),X.vertexAttribPointer(0,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null);return X.enableVertexAttribArray(H.getAttribute("textureCoordinates")),X.bindBuffer(X.ARRAY_BUFFER,t.coordId),X.vertexAttribPointer(1,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null),t},e.render=function(t){if(e.loadedImages<1)console.log("Not rendering");else{var r=W.getViewMatrix();mat4.translate(r,r,e.ship.transform.position),mat4.translate(r,r,[e.shiftX,e.shiftY,0]),t.bufferMatrix("modelview",r),X.useProgram(t.id),X.bindVertexArray(e.model.vaoId),X.uniform1i(t.getUniform("colorMap"),0),X.uniform1i(t.getUniform("blockMap"),1),t.bufferVec2("blockMapDimensions",[e.textureWidth,e.textureHeight]),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D_ARRAY,O.images.blocks.imageId),X.activeTexture(X.TEXTURE1),X.bindTexture(X.TEXTURE_2D,e.framebuffer.textureId),X.bindBuffer(X.ARRAY_BUFFER,e.model.id),X.vertexAttribPointer(t.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,e.model.coordId),X.vertexAttribPointer(t.getAttribute("textureCoordinates"),2,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,6),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null),X.activeTexture(X.TEXTURE0),e.renderSelectedBlock()}},e.renderSelectedBlock=function(){var r=W.getMouseWorldPosition(),o=r[0]-e.ship.transform.position[0],n=r[1]-e.ship.transform.position[1];null!=e.getLocalBlock(Math.round(o),Math.round(n))&&(vec3.set(t.transform.position,e.ship.transform.position[0]+Math.round(o),e.ship.transform.position[1]+Math.round(n),0),t.render())},e.loadFromImageTexture=function(t){e.blockImage=new Image,e.blockImage.onload=function(){e.blockId=X.createTexture(),X.bindTexture(X.TEXTURE_2D,e.blockId),X.texImage2D(X.TEXTURE_2D,0,X.RGBA,X.RGBA,X.UNSIGNED_BYTE,e.blockImage),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MIN_FILTER,X.NEAREST),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MAG_FILTER,X.NEAREST),e.loadedImages++},e.blockImage.src=blockMapName},e.loadFromProtobufBytes=function(t){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(t){var o=O.protoDefinition.Mass,n=new Uint8Array(r.response),i=o.decode(n);e.setupFromProtobuf(i)},r.send(null)},e.loadFromBytes=function(t){var r=O.protoDefinition.Mass,o=new Uint8Array(t),n=r.decode(o);e.setupFromProtobuf(n)},e.getHash=function(e,t){return(e<<16)+t},e.setupFromProtobuf=function(t){e.blockIndex=0,e.width=0,e.height=0,e.minX=0,e.maxX=0,e.minY=0,e.maxY=0,e.name=t.name;var r=t.blocks;if(r)for(var o=r.length-1;o>=0;o--){var n=r[o],i=n.type||0;n.type=i;var a=n.x||0;n.x=a;var s=n.y||0;n.y=s;var d=e.getHash(a,s);n.index=e.blockIndex,e.blocks[d]=e.blockIndex,e.blocksArray.push(n),e.blockIndex++,a>e.maxX&&(e.maxX=a),a<e.minX&&(e.minX=a),s>e.maxY&&(e.maxY=s),s<e.minY&&(e.minY=s)}e.width=e.maxX-e.minX+1,e.height=e.maxY-e.minY+1,e.createFramebuffer()},e.createFramebuffer=function(){console.log("width/height 1 "+e.textureWidth+" "+e.textureHeight+" from "+e.width+" "+e.height);var t=Math.max(Math.abs(e.minX),e.maxX),r=Math.max(Math.abs(e.minY),e.maxY);e.textureWidth=Math.pow(2,Math.ceil(Math.log(2*t+1)/Math.log(2))),e.textureHeight=Math.pow(2,Math.ceil(Math.log(2*r+1)/Math.log(2))),console.log("width/height 2 "+e.textureWidth+" "+e.textureHeight);e.width,e.minX,e.height,e.minY;e.shiftX=.5,e.shiftY=.5,e.framebuffer=f(e.textureWidth,e.textureHeight);for(var o=[],n=[],i=1/(.5*e.textureWidth),a=1/(.5*e.textureHeight),s=e.blocksArray.length-1;s>=0;s--){var d=e.blocksArray[s],u=d.x*i,c=d.y*a;o.push(u),o.push(c),n.push(d.type*(1/255)),n.push(0),n.push(0),n.push(1)}O.pointRenderer.bufferPoints(o,n),e.framebuffer.bind(),X.clear(X.COLOR_BUFFER_BIT),O.pointRenderer.render(),e.framebuffer.unbind(),e.model=e.createModel(),e.loadedImages++},e.destroyFramebuffer=function(){},e.downloadShip=function(){for(var t=O.protoDefinition.Mass,r={name:e.name,blocks:[]},o=e.blocksArray.length-1;o>=0;o--){var n=e.blocksArray[o];r.blocks.push(n)}var i=t.verify(r);if(i)throw Error(i);var a=t.create(r),s=t.encode(a).finish();saveAs(new Blob([s],{type:"example/binary"}),"data.dat")},e.canMoveTo=function(t,r){var o=e.getLocalBlock(Math.round(t),Math.round(r));return null!=o&&3==o.type},e.blocksShot=function(t,r){var o=e.getLocalBlock(Math.round(t),Math.round(r));return null!=o&&3!=o.type},e.worldToLocalX=function(t){var r=t-e.ship.transform.position[0];return Math.round(r)},e.worldToLocalY=function(t){var r=t-e.ship.transform.position[1];return Math.round(r)},e.getBlock=function(t,r){var o=e.worldToLocalX(t),n=e.worldToLocalY(r);return e.getLocalBlock(o,n)},e.getLocalBlock=function(t,r){var o=e.getHash(t,r),n=e.blocks[o];return null==n?null:e.blocksArray[n]},e.addBlock=function(t,r,o){if(null!=e.getBlock(r,o))console.log("Cannot add block there, already something there");else{var n=e.worldToLocalX(r),i=e.worldToLocalY(o);e.createBlock(t,n,i)}},e.createBlock=function(t,r,o){var n={type:t,x:r,y:o,index:e.blockIndex};e.blockIndex++,e.blocksArray.push(n);var i=e.getHash(r,o);e.blocks[i]=n.index,r>e.maxX&&(e.maxX=r),r<e.minX&&(e.minX=r),o>e.maxY&&(e.maxY=o),o<e.minY&&(e.minY=o),e.width=e.maxX-e.minX+1,e.height=e.maxY-e.minY+1;var a=r*(1/(.5*e.textureWidth)),s=o*(1/(.5*e.textureHeight));Math.max(Math.abs(e.minX),e.maxX),Math.max(Math.abs(e.minY),e.maxY);if(a>-1&&a<=1&&s>-1&&s<=1){var d=[],u=[];d.push(a),d.push(s),u.push(n.type*(1/255)),u.push(0),u.push(0),u.push(1),O.pointRenderer.bufferPoints(d,u),e.framebuffer.bind(),O.pointRenderer.render(),e.framebuffer.unbind()}else e.framebuffer.destroy(),e.createFramebuffer()},e.raycast=function(t,r){t.distance=r,t.hit=!1;for(var o=4*Math.ceil(r),n=t.origin,i=t.direction,a=0;a<o;a++){var s=e.worldToLocalX(n[0]+i[0]*a*.25),d=e.worldToLocalY(n[1]+i[1]*a*.25);if(e.blocksShot(s,d)){var u=vec2.create();return vec2.scale(u,i,.25*a),t.distance=vec2.squaredLength(u),void(t.hit=!0)}}},e}function l(e){var t={};return t.readyGeometry=!1,t.readyTextures=!1,t.model=function(r){var o={};return o.coordsBuffer=e.createBuffer(),o.indexBuffer=e.createBuffer(),o.count=r.indices.length,e.bindBuffer(e.ARRAY_BUFFER,o.coordsBuffer),e.bufferData(e.ARRAY_BUFFER,r.vertexPositions,e.STATIC_DRAW),console.log("buffer vertices: "+r.vertexPositions.length),console.log("buffer indecies: "+r.indices.length),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r.indices,e.STATIC_DRAW),t.readyGeometry=!0,o.render=function(){e.drawElements(e.TRIANGLES,o.count,e.UNSIGNED_SHORT,0)},o}(cube(50)),function(r){for(var o=0,n=new Array(6),i=0;i<6;i++)n[i]=new Image,n[i].onload=function(){if(6==++o){t.texID=e.createTexture(),e.bindTexture(e.TEXTURE_CUBE_MAP,t.texID);for(var r=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;i<6;i++)e.texImage2D(r[i],0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n[i]),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.generateMipmap(e.TEXTURE_CUBE_MAP),t.readyTextures=!0,console.log("Ready textures")}},n[i].src=r[i]}(["images/skyposx1.png","images/skynegx1.png","images/skyposy1.png","images/skynegy1.png","images/skyposz1.png","images/skynegz1.png"]),t.render=function(r){if(t.readyTextures&&t.readyGeometry){e.useProgram(r.id),e.bindTexture(e.TEXTURE_CUBE_MAP,t.texID),e.bindBuffer(e.ARRAY_BUFFER,t.model.coordsBuffer),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.model.indexBuffer),e.vertexAttribPointer(r.getAttribute("coords"),3,e.FLOAT,!1,0,0);var o=mat4.create();mat4.fromQuat(o,W.transform.rotation),r.bufferMatrix("modelview",o),t.model.render()}else console.log("Not yet ready")},t}function f(e,t){var r={};return r.width=e,r.height=t,r.createTexture=function(){r.textureId=X.createTexture(),X.bindTexture(X.TEXTURE_2D,r.textureId),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_WRAP_S,X.CLAMP_TO_EDGE),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_WRAP_T,X.CLAMP_TO_EDGE),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MIN_FILTER,X.NEAREST),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MAG_FILTER,X.NEAREST),X.texImage2D(X.TEXTURE_2D,0,X.RGBA,r.width,r.height,0,X.RGBA,X.UNSIGNED_BYTE,null),X.bindTexture(X.TEXTURE_2D,null)},r.createFrameBuffer=function(){r.id=X.createFramebuffer(),X.bindFramebuffer(X.FRAMEBUFFER,r.id),X.framebufferTexture2D(X.FRAMEBUFFER,X.COLOR_ATTACHMENT0,X.TEXTURE_2D,r.textureId,0),X.bindFramebuffer(X.FRAMEBUFFER,null)},r.bind=function(){X.bindFramebuffer(X.FRAMEBUFFER,r.id),X.viewport(0,0,r.width,r.height)},r.unbind=function(){X.bindFramebuffer(X.FRAMEBUFFER,null),X.viewport(0,0,V.width,V.height)},r.destroy=function(){console.log("Destroying framebuffer "+r.id),X.deleteFramebuffer(r.id),X.deleteTexture(r.textureId)},r.createTexture(),r.createFrameBuffer(),console.log("Created framebuffer: "+r.textureId+" ["+e+"x"+t+"]"),r}function m(){var e={};return e.count=0,e.createBuffers=function(){e.vertexPositionId=X.createBuffer(),e.colorPositionId=X.createBuffer(),e.vaoId=X.createVertexArray(),X.bindVertexArray(e.vaoId);X.enableVertexAttribArray(O.shaders.points.getAttribute("vertexPosition")),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.vertexAttribPointer(0,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null);X.enableVertexAttribArray(O.shaders.points.getAttribute("colorPosition")),X.bindBuffer(X.ARRAY_BUFFER,e.colorPositionId),X.vertexAttribPointer(1,4,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},e.bufferPoints=function(t,r){X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(t),X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,e.colorPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(r),X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,null),e.count=Math.floor(t.length/2)},e.render=function(){X.useProgram(O.shaders.points.id),X.bindVertexArray(e.vaoId),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.vertexAttribPointer(O.shaders.points.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,e.colorPositionId),X.vertexAttribPointer(O.shaders.points.getAttribute("colorPosition"),4,X.FLOAT,!1,0,0),X.drawArrays(X.POINTS,0,e.count),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},e.createBuffers(),e}function h(){var e={};e.cachedText={};var t=q;e.createTexture=function(){e.vaoId=X.createVertexArray(),e.vertexPositionId=X.createBuffer(),e.uvsPositionId=X.createBuffer(),X.bindVertexArray(e.vaoId);X.enableVertexAttribArray(t.getAttribute("vertexPosition")),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.vertexAttribPointer(0,2,X.FLOAT,!1,0,0);X.enableVertexAttribArray(t.getAttribute("textureCoordinates")),X.bindBuffer(X.ARRAY_BUFFER,e.uvsPositionId),X.vertexAttribPointer(1,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},e.renderText=function(r,o){r=r.toLowerCase();var n;e.cachedText[r]?n=e.cachedText[r]:(n=e.makeVerticesForString(r),o&&(e.cachedText[r]=n));var i=W.getViewMatrix(),a=astronaut.transform.position;mat4.translate(i,i,a),mat4.scale(i,i,[.03125,-.03125,.03125]),t.bufferMatrix("modelview",i),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.bufferData(X.ARRAY_BUFFER,n.arrays.position,X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,e.uvsPositionId),X.bufferData(X.ARRAY_BUFFER,n.arrays.texcoord,X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,null),X.useProgram(t.id),X.bindVertexArray(e.vaoId),X.uniform1i(t.getUniform("colorMap"),0),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D,O.images.font.imageId),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.vertexAttribPointer(t.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,e.uvsPositionId),X.vertexAttribPointer(t.getAttribute("textureCoordinates"),2,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,n.numVertices),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},e.renderTextAtScreen=function(r,o,n,i){r=r.toLowerCase();var a;e.cachedText[r]?a=e.cachedText[r]:(a=e.makeVerticesForString(r),o&&(e.cachedText[r]=a));W.transform.position;var s=mat4.create(),d=.5*V.width,u=.5*V.height;mat4.ortho(s,-d,d,-u,u,.1,100),t.bufferMatrix("projection",s);var c=mat4.create();mat4.fromTranslation(c,[-d+n,-u+i,-1]),t.bufferMatrix("modelview",c),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.bufferData(X.ARRAY_BUFFER,a.arrays.position,X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,e.uvsPositionId),X.bufferData(X.ARRAY_BUFFER,a.arrays.texcoord,X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,null),X.useProgram(t.id),X.bindVertexArray(e.vaoId),X.uniform1i(t.getUniform("colorMap"),0),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D,O.images.font.imageId),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.vertexAttribPointer(t.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,e.uvsPositionId),X.vertexAttribPointer(t.getAttribute("textureCoordinates"),2,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,a.numVertices),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null),t.bufferMatrix("projection",W.projectionMatrix)};var r={letterHeight:8,spaceWidth:8,spacing:-1,textureWidth:64,textureHeight:40,glyphInfos:{a:{x:0,y:0,width:8},b:{x:8,y:0,width:8},c:{x:16,y:0,width:8},d:{x:24,y:0,width:8},e:{x:32,y:0,width:8},f:{x:40,y:0,width:8},g:{x:48,y:0,width:8},h:{x:56,y:0,width:8},i:{x:0,y:8,width:8},j:{x:8,y:8,width:8},k:{x:16,y:8,width:8},l:{x:24,y:8,width:8},m:{x:32,y:8,width:8},n:{x:40,y:8,width:8},o:{x:48,y:8,width:8},p:{x:56,y:8,width:8},q:{x:0,y:16,width:8},r:{x:8,y:16,width:8},s:{x:16,y:16,width:8},t:{x:24,y:16,width:8},u:{x:32,y:16,width:8},v:{x:40,y:16,width:8},w:{x:48,y:16,width:8},x:{x:56,y:16,width:8},y:{x:0,y:24,width:8},z:{x:8,y:24,width:8},0:{x:16,y:24,width:8},1:{x:24,y:24,width:8},2:{x:32,y:24,width:8},3:{x:40,y:24,width:8},4:{x:48,y:24,width:8},5:{x:56,y:24,width:8},6:{x:0,y:32,width:8},7:{x:8,y:32,width:8},8:{x:16,y:32,width:8},9:{x:24,y:32,width:8},"-":{x:32,y:32,width:8},"*":{x:40,y:32,width:8},"!":{x:48,y:32,width:8},"?":{x:56,y:32,width:8}}};return e.makeVerticesForString=function(e){for(var t=e.length,o=6*t,n=new Float32Array(2*o),i=new Float32Array(2*o),a=0,s=0,d=r.textureWidth,u=r.textureHeight,c=0;c<t;++c){var l=e[c],f=r.glyphInfos[l];if(f){var m=s+f.width,h=f.x/d,A=(f.y+r.letterHeight-1)/u,g=(f.x+f.width-1)/d,p=f.y/u;n[a+0]=s,n[a+1]=0,i[a+0]=h,i[a+1]=A,n[a+2]=m,n[a+3]=0,i[a+2]=g,i[a+3]=A,n[a+4]=s,n[a+5]=r.letterHeight,i[a+4]=h,i[a+5]=p,n[a+6]=s,n[a+7]=r.letterHeight,i[a+6]=h,i[a+7]=p,n[a+8]=m,n[a+9]=0,i[a+8]=g,i[a+9]=A,n[a+10]=m,n[a+11]=r.letterHeight,i[a+10]=g,i[a+11]=p,s+=f.width+r.spacing,a+=12}else s+=r.spaceWidth}return{arrays:{position:new Float32Array(n.buffer,0,a),texcoord:new Float32Array(i.buffer,0,a)},numVertices:a/2}},e.createTexture(),e}function A(){var e={};return e.createBuffers=function(){e.vertexPositionId=X.createBuffer(),e.colorPositionId=X.createBuffer(),e.vaoId=X.createVertexArray(),X.bindVertexArray(e.vaoId);X.enableVertexAttribArray(O.shaders.lines.getAttribute("vertexPosition")),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.vertexAttribPointer(0,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null);X.enableVertexAttribArray(O.shaders.lines.getAttribute("colorPosition")),X.bindBuffer(X.ARRAY_BUFFER,e.colorPositionId),X.vertexAttribPointer(1,4,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},e.bufferPoints=function(t,r){X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(t),X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,e.colorPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(r),X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,null),e.count=Math.floor(t.length/2)},e.render=function(){X.useProgram(O.shaders.lines.id),X.bindVertexArray(e.vaoId);var t=W.getViewMatrix();O.shaders.lines.bufferMatrix("modelview",t),X.drawArrays(X.LINES,0,e.count),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},e.createBuffers(),e}function g(){var t={};return t.id=0,t.ship=null,t.transform=e(),t.rotZ=0,t.createModel=function(){var e={};e.vaoId=X.createVertexArray();var r=[-.25,-.25,.25,-.25,-.25,.25,-.25,.25,.25,-.25,.25,.25],o=[0,0,1,0,0,1,0,1,1,0,1,1];e.vertexPositionId=X.createBuffer(),e.uvsPositionId=X.createBuffer(),X.bindVertexArray(e.vaoId);X.enableVertexAttribArray(q.getAttribute("vertexPosition")),X.bindBuffer(X.ARRAY_BUFFER,e.vertexPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(r),X.STATIC_DRAW),X.vertexAttribPointer(0,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null);return X.enableVertexAttribArray(q.getAttribute("textureCoordinates")),X.bindBuffer(X.ARRAY_BUFFER,e.uvsPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(o),X.STATIC_DRAW),X.vertexAttribPointer(1,2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null),console.log(t),e},t.update=function(){t.mainPlayer&&(t.checkSendUpdateTransform(),t.ship?vec3.set(W.transform.position,t.ship.transform.position[0]+t.transform.position[0],t.ship.transform.position[1]+t.transform.position[1],-10):vec3.set(W.transform.position,t.transform.position[0],t.transform.position[1],-10))},t.render=function(){var e=W.getViewMatrix();t.ship&&mat4.translate(e,e,t.ship.transform.position),mat4.translate(e,e,t.transform.position);var r=Math.PI/180;if(t.mainPlayer){var o=W.getMouseWorldPosition(),n=vec3.create();vec3.add(n,o,t.transform.getNegativePosition()),t.ship&&vec3.add(n,n,t.ship.transform.getNegativePosition()),vec3.normalize(n,n);var i=Math.atan2(n[1],n[0]);t.rotZ=i,mat4.rotateZ(e,e,t.rotZ+90*r)}else mat4.rotateZ(e,e,t.rotZ+90*r);q.bufferMatrix("modelview",e),X.useProgram(q.id),X.bindVertexArray(t.model.vaoId),X.uniform1i(q.getUniform("colorMap"),0),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D,O.images.astronaut.imageId),X.bindBuffer(X.ARRAY_BUFFER,t.model.vertexPositionId),X.vertexAttribPointer(q.getAttribute("vertexPosition"),2,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,t.model.uvsPositionId),X.vertexAttribPointer(q.getAttribute("textureCoordinates"),2,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,6),X.bindBuffer(X.ARRAY_BUFFER,null),X.bindVertexArray(null)},t.setFrame=function(e){var r=e%16,o=Math.floor(e/16),n=.0625*r,i=.0625*(r+1),a=.0625*o,s=.0625*(o+1),d=[n,a,i,a,n,s,n,s,i,a,i,s];X.bindBuffer(X.ARRAY_BUFFER,t.model.uvsPositionId),X.bufferData(X.ARRAY_BUFFER,new Float32Array(d),X.STATIC_DRAW),X.bindBuffer(X.ARRAY_BUFFER,null)},t.move=function(e,r){var o=.1*r,n=-.1*e,i=t.transform.position[0]+o,a=t.transform.position[1]+n,s=!0;t.ship&&(s=t.ship.blockRenderer.canMoveTo(i,a)),s&&t.transform.addPosition([o,n,0])},t.checkSendUpdateTransform=function(){if(t.mainPlayer)if(t.lastSentUpdate){var e=Date.now();e-t.lastSentUpdate>500&&(t.lastSentUpdate=e,t.sendUpdateTransform())}else t.lastSentUpdate=Date.now(),t.sendUpdateTransform()},t.sendUpdateTransform=function(){if(O.gameSocket){var e=t.transform.position,r={type:10,updatePlayerTransform:{identity:t.id,x:e[0],y:e[1],rotationZ:t.rotZ}};O.gameSocket.sendMsg(r)}},t.checkSendSteerShip=function(e,r){if(t.mainPlayer)if(t.ship&&(t.ship.steering[0]=e,t.ship.steering[1]=r),0==e&&0==r)t.hasStartedDriving&&(t.hasStartedDriving=!1,t.sendSteerShip(e,r));else if(t.hasStartedDriving=!0,t.lastSentSteer){var o=Date.now();o-t.lastSentSteer>30&&(t.lastSentSteer=o,t.sendSteerShip(e,r))}else t.lastSentSteer=Date.now(),t.sendSteerShip(e,r)},t.sendSteerShip=function(e,r){var o={type:12,steerShip:{identity:t.id,shipId:t.ship.id,dx:e,dy:r}};O.gameSocket.sendMsg(o)},t.updateTransform=function(e){t.transform.position=[e.x,e.y,0],t.rotZ=e.rotationZ,e.attachedShip&&O.hotspot?t.ship=O.hotspot.getShip(e.attachedShip):null==e.attachedShip&&O.hotspot},t.isDriving=function(){return null!=t.ship},t.model=t.createModel(),t}function p(t){var r={};return r.id=0,r.blockRenderer=t,t.ship=r,r.transform=e(),r.velocity=[0,0],r.steering=[0,0],r.createdAt=new Date,r.update=function(){if(Math.abs(r.steering[0])>0||Math.abs(r.steering[1])>0){r.velocity[0]+=5*r.steering[0]*O.time.deltaTime,r.velocity[1]+=5*r.steering[1]*O.time.deltaTime}var e=r.velocity[0]*O.time.deltaTime,t=r.velocity[1]*O.time.deltaTime;(Math.abs(e)>0||Math.abs(t)>0)&&r.transform.addPosition([e,t,0])},r.render=function(){},r.secondsSinceCreated=function(){return(new Date-r.createdAt)/1e3},r}function R(){var e={};return e.locked=!1,e.fpsControls=!1,e.lastX=0,e.lastY=0,V.addEventListener("mousemove",function(t){if(e.locked)if(e.fpsControls){var r=t.movementX||t.mozMovementX||t.webkitMovementX||0,o=t.movementY||t.mozMovementY||t.webkitMovementY||0,n=.05*r;W.yaw+=n;i=.05*o;W.pitch+=i,W.pitch>90?W.pitch=90:W.pitch<-90&&(W.pitch=-90);var i=quat.create();quat.setAxisAngle(i,[1,0,0],glMatrix.toRadian(W.pitch));n=quat.create();quat.setAxisAngle(n,[0,1,0],glMatrix.toRadian(W.yaw));var a=quat.create();quat.mul(a,i,n),quat.normalize(a,a),quat.copy(W.transform.rotation,a)}else console.log("Mouse locked, but no fps controls");else x(V,t)},!1),document.addEventListener("pointerlockchange",function(t){console.log("pointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("mozpointerlockchange",function(t){console.log("mozpointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("webkitpointerlockchange",function(t){console.log("webkitpointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("pointerlockerror",function(e){console.log("pointerlockerror "+e)},!1),document.addEventListener("mozpointerlockerror",function(e){console.log("mozpointerlockerror "+e)},!1),document.addEventListener("webkitpointerlockerror",function(e){console.log("webkitpointerlockerror "+e)},!1),V.addEventListener("click",function(t){if(e.fpsControls&&!e.locked&&e.canLock())console.log("Clicked on canvas, trying to lock"),e.lock();else{var r=W.getMouseWorldPosition();if(O.hotspot){var o=O.hotspot.getMainPlayer(),n=o.transform.position[0],i=o.transform.position[1],a=r[0],s=r[1];if(o.ship){n+=o.ship.transform.position[0],i+=o.ship.transform.position[1];var d={origin:vec2.fromValues(n,i),direction:vec2.fromValues(a,s)};if(vec2.add(d.direction,d.direction,vec2.fromValues(-n,-i)),vec2.normalize(d.direction,d.direction),o.ship.blockRenderer.raycast(d,25),console.log("Hit ship? "+d.hit+": "+d.distance),d.hit){vec2.fromValues(n,i);var u=vec2.create();vec2.copy(u,d.direction),vec2.scale(u,u,d.distance),a=n+u[0],s=i+u[1],console.log("Final "+a+" "+s)}}O.hotspot.createProjectile(O.hotspot.getMainPlayerId(),1,n,i,a,s)}}},!1),e.update=function(){},e.canLock=function(){var e="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;return console.log("Can mouse lock: "+e),e},e.lock=function(){console.log("Trying to lock"),V.requestPointerLock=V.requestPointerLock||V.mozRequestPointerLock||V.webkitRequestPointerLock,V.requestPointerLock()},e.unlock=function(){console.log("Trying to unlock"),document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()},e.onLockChanged=function(t){document.pointerLockElement===V||document.mozPointerLockElement===V||document.webkitPointerLockElement===V?(console.log("enabled lock"),e.locked=!0):(console.log("disabled lock"),e.locked=!1)},e}function x(e,t){var r=e.getBoundingClientRect();j.lastX=t.clientX-r.left,j.lastY=t.clientY-r.top}function b(){var e={};return document.onkeydown=T,document.onkeyup=E,e.update=function(){e.topDownControls()},e.uiCapturedInput=function(){for(var e=O.ui.stack.length-1;e>=0;e--)if(O.ui.stack[e].capturedInput&&O.ui.stack[e].capturedInput())return!0;return!1},e.topDownControls=function(){if(!e.uiCapturedInput()){var t=0;t+=v("W")?1:0,t-=v("S")?1:0;var r=0;if(r+=v("D")?1:0,r-=v("A")?1:0,O.hotspot){O.hotspot.moveMainPlayer(t,r);var o=O.hotspot.getMainPlayer();if(o&&o.isDriving()){var n=0,i=0;Y[97]&&(n+=-.5,i+=.5),Y[100]&&(n+=-1),Y[103]&&(n+=-.5,i+=-.5),Y[99]&&(n+=.5,i+=.5),Y[102]&&(n+=1),Y[105]&&(n+=.5,i+=-.5),Y[104]&&(i+=-1),Y[98]&&(i+=1),o.checkSendSteerShip(n,i)}}var a=0;a+=v("X")?1:0,((a-=v("Z")?1:0)<0||a>0)&&W.addOrtho(a)}},e.fpsControls=function(){var e=vec3.create(),t=vec3.create(),r=quat.create();quat.invert(r,W.transform.rotation),vec3.transformQuat(t,[0,0,1],r),quat.copy(e,t);var o=0;o+=v("W")?1:0,o-=v("S")?1:0,e[1]=0,vec3.normalize(e,e),vec3.scale(e,e,.1*o),W.transform.addPosition(e);var n=vec3.create();vec3.cross(n,t,[0,1,0]);var i=0;i+=v("D")?1:0,i-=v("A")?1:0,n[1]=0,vec3.normalize(n,n),vec3.scale(n,n,.1*i),W.transform.addPosition(n)},e}function v(e){return!!C[e]&&1==C[e]}function T(e){C[String.fromCharCode(e.keyCode)]=!0,Y[e.keyCode]=!0;for(var t=0,r=O.ui.stack.length;t<r;t++){var o=O.ui.stack[t];o&&o.handleKeyDown&&o.handleKeyDown(String.fromCharCode(e.keyCode),e.keyCode)}}function E(e){C[String.fromCharCode(e.keyCode)]=!1,Y[e.keyCode]=!1}function y(){var t={};return t.projectionMatrix=mat4.create(),t.transform=e(),t.yaw=0,t.pitch=0,t.translation=mat4.create(),t.rotation=mat4.create(),t.viewMatrix=mat4.create(),t.mouseWorldPosition=vec3.create(),t.aspectRatio=1,t.minOrtho=2,t.maxOrtho=20,t.orthographicSize=10,t.orthoLeft=0,t.orthoRight=0,t.orthoTop=0,t.orthoBottom=0,t.shadersThatHasProjectionMatrix=[],t.setResolution=function(e,r){t.aspectRatio=e/r,console.log("Setting resolution "+e+" "+r+": "+t.aspectRatio)},t.setOrthographicSize=function(e){t.orthographicSize=e;var r=1/t.aspectRatio;t.orthographic(-t.orthographicSize*r,t.orthographicSize*r,t.orthographicSize,-t.orthographicSize,.1,100)},t.addOrtho=function(e){var r=t.orthographicSize+e;r<t.minOrtho?r=t.minOrtho:r>t.maxOrtho&&(r=t.maxOrtho),t.setOrthographicSize(r)},t.perspective=function(e,r,o,n){mat4.perspective(t.projectionMatrix,e,r,o,n)},t.orthographic=function(e,r,o,n,i,a){t.orthoLeft=e,t.orthoRight=r,t.orthoTop=n,t.orthoBottom=o,mat4.ortho(t.projectionMatrix,e,r,o,n,i,a);for(var s=t.shadersThatHasProjectionMatrix.length-1;s>=0;s--)t.shadersThatHasProjectionMatrix[s].bufferMatrix("projection",t.projectionMatrix)},t.getViewMatrix=function(){mat4.identity(t.viewMatrix);var e=t.transform.getNegativePosition();return e[2]=-e[2],mat4.fromTranslation(t.translation,e),mat4.fromQuat(t.rotation,t.transform.rotation),mat4.mul(t.viewMatrix,t.rotation,t.translation),t.viewMatrix},t.getMouseWorldPosition=function(){var e=j.lastX,r=j.lastY,o=V.width,n=V.height;return e=(e-.5*o)/o*2,r=(r-.5*n)/n*2,e*=e<0?-t.orthoLeft:t.orthoRight,r*=r<0?t.orthoBottom:-t.orthoTop,vec3.set(t.mouseWorldPosition,e+t.transform.position[0],r+t.transform.position[1],0),t.mouseWorldPosition},t}function F(e,t){var o=new WebSocket(e);return o.binaryType="arraybuffer",o.authenticated=!1,o.toFlush=[],o.onopen=function(e){console.log("WebSocket Game: On connected"),o.sendMsg({type:3})},o.onmessage=function(e){var r=new Uint8Array(e.data),n=t.decode(r);o.authenticated?o.toFlush.push(n):2==n.type||3==n.type?o.messageMap[n.type](n):console.log("WebSocket Game: Got message before authenticated "+n.type)},o.flush=function(){var e=o.toFlush.length;if(!(e<=0)){for(var t=0;t<e;t++){var r=o.toFlush[t];o.messageMap[r.type]?o.messageMap[r.type](r):console.log("WebSocket Game: Could not find func map for msg "+r.type)}for(;o.toFlush.length>0;)o.toFlush.pop()}},o.gotAuthenticate=function(e){1==e.authenticateResponse.statusCode?(console.log("WebSocket Game: Successfully authenticated"),o.authenticated=!0,o.sendMsg({type:4,requestHotspot:{hotspotId:O.targetHotspot}})):(console.log("WebSocket Game: Could not authenticate "+e.authenticateResponse.statusCode),o.authenticated=!1)},o.gotAuthenticateResponse=function(e){o.sendMsg({type:1,authenticate:{playerId:1,token:"hah"}})},o.gotIdentity=function(e){var t=e.identity.identity,o=e.identity.hotspotId;O.hotspot&&console.log("WebSocket Game Error: already have hotspot "+O.hotspot.id),O.hotspot=r(o,t)},o.gotCreatePlayer=function(e){O.hotspot?O.hotspot.createPlayer(e.createPlayer):console.log("WebSocket Game: no hotspot to gotCreatePlayer")},o.gotRemovePlayer=function(e){O.hotspot?O.hotspot.removePlayer(e.removePlayer):console.log("WebSocket Game: no hotspot to gotRemovePlayer")},o.gotCreateShip=function(e){O.hotspot?O.hotspot.createShip(e.createShip):console.log("WebSocket Game: no hotspot to gotCreateShip")},o.gotRemoveShip=function(e){O.hotspot?O.hotspot.removeShip(e.removeShip):console.log("WebSocket Game: no hotspot to gotRemoveShip")},o.gotUpdatePlayerTransform=function(e){O.hotspot?O.hotspot.updatePlayerTransform(e.updatePlayerTransform):console.log("WebSocket Game: no hotspot to gotUpdatePlayerTransform")},o.gotUpdateShipTransform=function(e){O.hotspot?O.hotspot.updateShipTransform(e.updateShipTransform):console.log("WebSocket Game: no hotspot to gotUpdateShipTransform")},o.messageMap={},o.messageMap[2]=o.gotAuthenticate,o.messageMap[3]=o.gotAuthenticateResponse,o.messageMap[5]=o.gotIdentity,o.messageMap[6]=o.gotCreatePlayer,o.messageMap[7]=o.gotRemovePlayer,o.messageMap[8]=o.gotCreateShip,o.messageMap[9]=o.gotRemoveShip,o.messageMap[10]=o.gotUpdatePlayerTransform,o.messageMap[11]=o.gotUpdateShipTransform,o.sendMsg=function(e){if(o.readyState!==o.CLOSED&&o.readyState!==o.CLOSING){var r=t.verify(e);if(r)console.error("WebSocket Game: Invalid msg "+e+" "+r);else{var n=t.create(e),i=t.encode(n).finish();o.send(i)}}else console.error("WebSocket Game: invalid state to send msg: "+o.readyState)},o}function P(e,t){var r=new WebSocket(e);return r.binaryType="arraybuffer",r.authenticated=!1,r.onopen=function(e){console.log("WebSocket: On connected"),r.sendMsg({type:3})},r.onmessage=function(e){console.log("WebSocket: Got message "+e+" "+e.data+" "+e.data.byteLength),console.log(e.data);var o=new Uint8Array(e.data),n=t.decode(o);if(r.authenticated){if(console.log("WebSocket: Authenticated, handling "+n.type),7==n.type){O.gameSocket&&console.log("WebSocket: Already connected to game server");var i=n.requestTravelResponse,a="wss:"+i.serverAddress;O.debug&&(a="ws:"+i.serverAddress),O.gameSocket=F(a,O.protoDefinition.GameBase)}for(var s=0,d=O.ui.stack.length;s<d;s++){var u=O.ui.stack[s];u&&u.onmessage&&u.onmessage(n)}}else if(3==n.type)if(O.account.token)r.sendMsg({type:1,authenticate:{playerId:O.account.playerId,token:O.account.token}});else if(O.account.google){c=O.account.googleUser.getAuthResponse().id_token;r.sendMsg({type:8,googleSignIn:{token:c}})}else console.error("No way of signing in.. stuck");else if(2==n.type)1==n.authenticateResponse.statusCode?(console.log("WebSocket: Successfully authenticated"),r.authenticated=!0,O.account.backend={}):(console.log("WebSocket: Could not authenticate "+n.authenticateResponse.statusCode),r.authenticated=!1);else if(9==n.type)if(console.log("sign in response:"),console.log(n.signInResponse),1==n.signInResponse.statusCode)r.authenticated=!0,O.account.backend={},O.account.setCookie("token",n.signInResponse.token,365),O.account.setCookie("playerId",n.signInResponse.playerId,365);else{var c=O.account.googleUser.getAuthResponse().id_token;r.sendMsg({type:10,register:{googleToken:c,username:"okgo"}})}else 11==n.type&&(1==n.signInResponse.statusCode?(r.authenticated=!0,O.account.backend={},O.account.setCookie("token",n.signInResponse.token,365),O.account.setCookie("playerId",n.signInResponse.playerId,365)):console.error("ERROR: could not sign in with google or register new user with google"))},r.sendMsg=function(e){var o=t.verify(e);if(o)console.log("WebSocket: Invalid msg "+e+" "+o);else{var n=t.create(e),i=t.encode(n).finish();console.log("WebSocket: Sending "+i.byteLength+" bytes"),r.send(i)}},r}function S(e){O.protoDefinition={},O.images={};var t={};return t.nextId=1,t.queue=[],t.createLoader=function(e){var r={};return r.done=!1,r.id=t.nextId,t.nextId++,r.loadFunc=e,r},t.loadAll=function(){for(var e=t.queue.length-1;e>=0;e--)t.queue[e].loadFunc()},t.loadTexture=function(e,r,o,n,i,a){var s=t.createLoader(function(){var d=new Image;O.images[r]={},O.images[r].image=d,d.onload=function(){var e=X.createTexture();O.images[r].imageId=e,X.bindTexture(X.TEXTURE_2D,e),X.texImage2D(X.TEXTURE_2D,0,X.RGBA,X.RGBA,X.UNSIGNED_BYTE,d),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MIN_FILTER,o),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MAG_FILTER,n),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_WRAP_S,a),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_WRAP_T,a),i&&X.generateMipmap(X.TEXTURE_2D),console.log("AssetLoader: Ready texture: "+r),t.onCompleteDownload(s)},d.src=e});t.queue.push(s)},t.loadTextureArray=function(e,r){var o=t.createLoader(function(){var n=new Image;O.images[r]={},O.images[r].image=n,n.onload=function(){var i=X.createTexture();O.images[r].imageId=i;var a=document.createElement("canvas");a.width=1024,a.height=1024;var s=a.getContext("2d");s.drawImage(n,0,0),X.activeTexture(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D_ARRAY,i),X.texParameteri(X.TEXTURE_2D_ARRAY,X.TEXTURE_MIN_FILTER,X.LINEAR_MIPMAP_LINEAR),X.texParameteri(X.TEXTURE_2D_ARRAY,X.TEXTURE_MAG_FILTER,X.LINEAR),X.texParameteri(X.TEXTURE_2D_ARRAY,X.TEXTURE_WRAP_S,X.CLAMP_TO_EDGE),X.texParameteri(X.TEXTURE_2D_ARRAY,X.TEXTURE_WRAP_T,X.CLAMP_TO_EDGE);for(var d=new Uint8Array(4194304),u=0;u<16;u++)for(var c=0;c<16;c++)for(var l=16*u+c,f=s.getImageData(64*c,64*u,64,64),m=new Uint8Array(f.data.buffer),h=0;h<16384;h++)d[16384*l+h]=m[h];X.texImage3D(X.TEXTURE_2D_ARRAY,0,X.RGBA,64,64,256,0,X.RGBA,X.UNSIGNED_BYTE,d),X.generateMipmap(X.TEXTURE_2D_ARRAY),console.log("AssetLoader: Ready texture array: "+e),t.onCompleteDownload(o)},n.src=e});t.queue.push(o)},t.loadProtobufDefinition=function(e,r){var o=t.createLoader(function(){console.log("AssetLoader: starting protobuf "+e),protobuf.load(e,function(n,i){if(console.log("AssetLoader: loaded protobuf "+e),n)throw n;O.protoDefinition[r]=i.lookupType(r),t.onCompleteDownload(o)})});t.queue.push(o)},t.loadAudioAsset=function(e){},t.onCompleteDownload=function(r){for(var o=t.queue.length-1;o>=0;o--)t.queue[o].id==r.id&&t.queue.splice(o,1);t.queue.length<=0&&(console.log("AssetLoader: All Assets Loaded"),e())},t}function main(){V=document.getElementById("webcanvas"),B(),O.loader=S(_),O.loader.loadProtobufDefinition("proto/WebsocketProto.proto","Base"),O.loader.loadProtobufDefinition("proto/WebsocketGameProto.proto","GameBase"),O.loader.loadProtobufDefinition("proto/BlockShip.proto","Mass"),O.loader.loadTexture("images/astronaut.png","astronaut",X.NEAREST,X.NEAREST,!1,X.CLAMP_TO_EDGE),O.loader.loadTexture("images/ui.png","ui",X.NEAREST,X.NEAREST,!1,X.CLAMP_TO_EDGE),O.loader.loadTexture("images/font.png","font",X.NEAREST,X.NEAREST,!1,X.CLAMP_TO_EDGE),O.loader.loadTexture("images/fog.png","fog",X.NEAREST,X.NEAREST,!1,X.REPEAT),O.loader.loadTextureArray("images/blocks.png","blocks"),O.account.token=O.account.getCookie("token"),O.account.playerId=O.account.getCookie("playerId"),O.shaders={},O.ui={},O.ui.stack=[],O.loader.loadAll()}function onSignIn(e){console.log("Got Google Sign In Callback"),O.account.googleUser=e;var t=O.account.googleUser.getBasicProfile();O.account.google=t;var r=O.account.googleUser.getAuthResponse().id_token;console.log("ID token: "+r),console.log("ID: "+t.getId()),console.log("Name: "+t.getName()),console.log("Image URL: "+t.getImageUrl()),console.log("Email: "+t.getEmail())}function _(){j=R(),z=b(),(W=y()).setResolution(V.width,V.height),W.setOrthographicSize(W.minOrtho),W.transform.addPosition([0,0,-10]),(G=i(X,"shader-vs","shader-fs")).addAttribute("aVertexPosition"),G.enableVertexAttributeArray(G.getAttribute("aVertexPosition")),G.addUniform("uPMatrix"),G.addUniform("uMVMatrix"),(N=i(X,"skyboxVertexShader","skyboxFragmentShader")).addAttribute("coords"),N.enableVertexAttributeArray(N.getAttribute("coords")),N.addUniform("modelview"),N.addUniform("projection"),N.bufferMatrix("projection",W.projectionMatrix),W.shadersThatHasProjectionMatrix.push(N),(q=i(X,"quadVertexShader","quadFragmentShader")).addAttribute("vertexPosition"),q.addAttribute("textureCoordinates"),q.addUniform("colorMap"),q.addUniform("modelview"),q.addUniform("projection"),q.bufferMatrix("projection",W.projectionMatrix),W.shadersThatHasProjectionMatrix.push(q),O.shaders.quadOffsetVertexShader=i(X,"quadOffsetVertexShader","quadOffsetFragmentShader"),O.shaders.quadOffsetVertexShader.addAttribute("vertexPosition"),O.shaders.quadOffsetVertexShader.addAttribute("textureCoordinates"),O.shaders.quadOffsetVertexShader.addUniform("colorMap"),O.shaders.quadOffsetVertexShader.addUniform("modelview"),O.shaders.quadOffsetVertexShader.addUniform("projection"),O.shaders.quadOffsetVertexShader.addUniform("uvOffset"),O.shaders.quadOffsetVertexShader.bufferMatrix("projection",W.projectionMatrix),O.shaders.quadOffsetVertexShader.bufferVec2("uvOffset",[0,0]),W.shadersThatHasProjectionMatrix.push(O.shaders.quadOffsetVertexShader),(H=i(X,"blockVertexShader","blockFragmentShader")).addAttribute("vertexPosition"),H.addAttribute("textureCoordinates"),H.addUniform("modelview"),H.addUniform("projection"),H.addUniform("colorMap"),H.addUniform("blockMap"),H.addUniform("blockMapDimensions"),H.bufferMatrix("projection",W.projectionMatrix),W.shadersThatHasProjectionMatrix.push(H),O.shaders.points=i(X,"pointsVertexShader","pointsFragmentShader"),O.shaders.points.addAttribute("vertexPosition"),O.shaders.points.addAttribute("colorPosition"),O.shaders.points.addUniform("modelview"),O.shaders.points.addUniform("projection"),O.shaders.points.bufferMatrix("projection",W.projectionMatrix),W.shadersThatHasProjectionMatrix.push(O.shaders.points),O.shaders.lines=i(X,"linesVertexShader","linesFragmentShader"),O.shaders.lines.addAttribute("vertexPosition"),O.shaders.lines.addAttribute("colorPosition"),O.shaders.lines.addUniform("modelview"),O.shaders.lines.addUniform("projection"),O.shaders.lines.bufferMatrix("projection",W.projectionMatrix),W.shadersThatHasProjectionMatrix.push(O.shaders.lines),O.pointRenderer=m(),O.backgroundSprite=d(O.images.fog,256),O.ui.stack.push(n()),X.clearColor(0,0,0,0),X.disable(X.DEPTH_TEST),O.time={},O.time.fps=0,O.time.fpsCounter=0,O.time.targetFps=60,O.time.skipTicks=1e3/O.time.targetFps,O.time.deltaTime=0,O.time.maxFrameSkip=10,O.time.timeSinceStart=0,Q=h(),window.onEachFrame(O.frame)}function B(){try{X=V.getContext("webgl2"),O.screen={},O.screen.fullscreen=!1,O.screen.width=V.width,O.screen.height=V.height,U(O.screen.width,O.screen.height),X.enable(X.BLEND),X.blendFunc(X.SRC_ALPHA,X.ONE_MINUS_SRC_ALPHA),console.log("WebGL loaded!")}catch(e){console.log("Could not get webgl")}X||alert("Could not initialise WebGL, sorry :-( ")}function U(e,t){console.log("New size "+e+" "+t),X.viewportWidth=e,X.viewportHeight=t,X.viewport(0,0,X.viewportWidth,X.viewportHeight)}function k(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){var e=V.clientWidth,t=V.clientHeight;V.width==e&&V.height==t||(V.width=e,V.height=t,U(V.width,V.height))}else V.width=O.screen.width,V.height=O.screen.height,U(O.screen.width,O.screen.height)}function toggleFullScreen(){document.addEventListener("fullscreenchange",k),document.addEventListener("webkitfullscreenchange",k),document.addEventListener("mozfullscreenchange",k),document.addEventListener("MSFullscreenChange",k),document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled?(O.screen.fullscreenWidth=V.clientWidth,O.screen.fullscreenHeight=V.clientHeight,document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():V.requestFullscreen?V.requestFullscreen():V.webkitRequestFullscreen?V.webkitRequestFullscreen():V.mozRequestFullScreen?V.mozRequestFullScreen():V.msRequestFullscreen&&V.msRequestFullscreen()):console.log("Cannot go Full Screen")}function I(){if(O.account.locallyAuthenticated)O.account.remotelyAuthenticated?(w(),M(),D()):O.account.backend&&(console.log("We are now authenticated with backend!"),O.account.remotelyAuthenticated=!0,O.ui.stack=[],O.ui.stack.push(o()));else{var e=!1;if(O.account.token?(console.log("We have stored token!"),O.account.locallyAuthenticated=!0,e=!0):O.account.google&&(console.log("We are now authenticated with google!"),O.account.locallyAuthenticated=!0,e=!0),e){var t="wss://84.211.52.237:443/websocket";O.debug&&(t="ws://localhost:8080/websocket"),O.socket=P(t,O.protoDefinition.Base)}}}function w(){O.gameSocket&&O.gameSocket.flush()}function M(){j.update(),z.update()}function D(){O.hotspot&&O.hotspot.update()}function L(){X.clear(X.COLOR_BUFFER_BIT|X.DEPTH_BUFFER_BIT),O.hotspot&&O.hotspot.render();for(var e=0,t=O.ui.stack.length;e<t;e++)O.ui.stack[e].render();Q.renderTextAtScreen("FPS: "+O.time.fps,!0,0,V.height-8,1)}console.log("Prepared shaders");var C={},Y={},X,V,O={};O.account={locallyAuthenticated:!1,remotelyAuthenticated:!1},O.debug=window.location.href.indexOf("localhost")>-1;var W,G,N,q,H,j,z,Z,K,Q;!function(){var e;window.requestAnimationFrame?(console.log("window.requestAnimationFrame"),e=function(e){var t=function(){e(),requestAnimationFrame(t)};t()}):window.webkitRequestAnimationFrame?(console.log("window.webkitRequestAnimationFrame"),e=function(e){var t=function(){e(),webkitRequestAnimationFrame(t)};t()}):window.mozRequestAnimationFrame?(console.log("window.mozRequestAnimationFrame"),e=function(e){var t=function(){e(),mozRequestAnimationFrame(t)};t()}):(console.log("setInterval"),e=function(e){setInterval(e,Game.skipTicks)}),window.onEachFrame=e}(),O.frame=function(){var e=0,t=Date.now(),r=Date.now();return function(){for(e=0;Date.now()>t&&e<O.time.maxFrameSkip;)O.time.deltaTime=.001*(t-r-O.time.timeSinceStart),Math.floor(.001*O.time.timeSinceStart)<Math.floor(.001*O.time.timeSinceStart+O.time.deltaTime)&&(O.time.fps=O.time.fpsCounter,O.time.fpsCounter=0),O.time.timeSinceStart=t-r,I(),O.time.fpsCounter++,t+=O.time.skipTicks,e++;L()}}(),O.account.setCookie=function(e,t,r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3);var n="expires="+o.toUTCString();document.cookie=e+"="+t+";"+n+";path=/"},O.account.eraseCookie=function(e){O.account.setCookie(e,"",0)},O.account.getCookie=function(e){for(var t=e+"=",r=document.cookie.split(";"),o=0;o<r.length;o++){for(var n=r[o];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""},O.getUiForType=function(e){for(var t=0,r=O.ui.stack.length;t<r;t++){var o=O.ui.stack[t];if(o.type==e)return o}return null};