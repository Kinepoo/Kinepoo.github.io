function e(){var e={};return e.position=vec3.create(),e.rotation=quat.create(),quat.identity(e.rotation),e.scale=[1,1,1],e.invPosition=vec3.create(),e.addPosition=function(t){vec3.add(e.position,e.position,t)},e.getNegativePosition=function(){return vec3.scale(e.invPosition,e.position,-1),e.invPosition},e}function t(e,t,r,o,n,a){var i={};return i.type=e,i.owner=t,i.position=[r,o],i.velocity=[n,a],i.update=function(){i.lifetimeLeft-=W.time.deltaTime},i.createRenderer=function(){if(1==e){i.renderer=p();var t=[r,o,n,a],s=[1,0,0,1,1,0,0,1];i.renderer.bufferPoints(t,s)}},i.render=function(){i.renderer&&i.renderer.render()},i.setLifetimeLeft=function(){i.lifetimeLeft=1==e?.25:0},i.canDamage=function(e){return e!=i.owner&&i.lifetimeLeft>0},i.shouldRemove=function(){return i.lifetimeLeft<=0},i.setLifetimeLeft(),i.createRenderer(),i}function r(e,r){var o={};return o.id=e,o.mainPlayerId=r,o.players=[],o.playerMap={},o.ships=[],o.shipMap={},o.projectiles=[],console.log("Created hotspot "+e+" myId "+r),o.createLocalPlayer=function(){console.log("Create local player"),o.mainPlayer=g(),o.mainPlayer.id=r,o.mainPlayer.mainPlayer=!0,o.mainPlayer.setFrame(0),o.players.push(o.mainPlayer),o.playerMap[r]=o.mainPlayer},o.createPlayer=function(e){var t=e.identity;console.log("Create player "+t);var r=g();r.id=t,r.setFrame(0),o.players.push(r),o.playerMap[t]=r},o.removePlayer=function(e){var t=e.identity;console.log("remove player "+t);for(var r=o.players.length-1;r>=0;r--)o.players[r].id==t&&o.players.splice(r,1)},o.getPlayer=function(e){return o.playerMap[e]},o.getMainPlayer=function(){return o.getPlayer(o.mainPlayerId)},o.getMainPlayerId=function(){return o.mainPlayerId},o.createShip=function(e){var t=e.identity;console.log("Create ship "+t);var r=c();r.loadFromBytes(e.ship);var n=A(r);n.id=t,o.ships.push(n),o.shipMap[t]=n},o.removeShip=function(e){var t=e.identity;console.log("remove ship "+t);for(var r=o.ships.length-1;r>=0;r--)o.ships[r].id==t&&o.ships.splice(r,1)},o.getShip=function(e){return o.shipMap[e]},o.updatePlayerTransform=function(e){var t=o.playerMap[e.identity];t?t.updateTransform(e):console.log("Hotspot ERROR: could not find player "+e.identity)},o.updateShipTransform=function(e){var t=o.getShip(e.identity);if(t){var r=e.x||0,n=e.y||0,a=e.vx||0,i=e.vy||0;t.transform.position[0],t.transform.position[1];vec3.set(t.transform.position,r,n,0),t.velocity[0]=a,t.velocity[1]=i}else console.log("Hotspot ERROR: could not find ship "+e.identity)},o.update=function(){for(e=o.ships.length-1;e>=0;e--)o.ships[e].update();for(e=o.players.length-1;e>=0;e--)o.players[e].update();for(var e=o.projectiles.length-1;e>=0;e--)o.projectiles[e].update(),o.projectiles[e].shouldRemove()&&o.projectiles.splice(e,1)},o.moveMainPlayer=function(e,t){o.mainPlayer.move(e,t)},o.render=function(){W.backgroundSprite.renderScreenSpaceUvOffset();for(e=o.ships.length-1;e>=0;e--)o.ships[e].blockRenderer.render(j);for(e=o.players.length-1;e>=0;e--)o.players[e].render();for(var e=o.projectiles.length-1;e>=0;e--)o.projectiles[e].render()},o.createProjectile=function(e,r,n,a,i,s){var d=t(r,e,n,a,i,s);o.projectiles.push(d)},o.createLocalPlayer(),o}function o(){var e={};return e.type=2,e.stateRoot=0,e.stateHyperdrive=1,e.stateSave=2,e.stateLoad=3,e.state=0,e.inputText="",e.destinations=[],e.render=function(){if(e.state==e.stateRoot)W.hotspot,$.renderTextAtScreen("-1- HYPERDRIVE",!0,0,16),$.renderTextAtScreen("-2- SAVE",!0,0,8),$.renderTextAtScreen("-3- LOAD",!0,0,0);else if(e.state==e.stateHyperdrive){var t=e.destinations.length;if(t>0){var r=8*t;$.renderTextAtScreen("-ESC- Back",!0,0,16),$.renderTextAtScreen("-Enter destination-",!0,0,8),e.inputText.length>0&&e.inputText.trim().length>0&&$.renderTextAtScreen(e.inputText,!0,0,0);for(var o=0;o<e.destinations.length;o++){var n=e.destinations[o];$.renderTextAtScreen(n.id+" "+n.name,!0,0,r-8*o+24)}}else $.renderTextAtScreen("loading destinations..",!0,0,0)}},e.setState=function(t){e.state=t,t==e.stateHyperdrive&&(e.destinations.length<=0?(console.log("need to ask server for destinations"),W.socket.sendMsg({type:4})):console.log("has "+e.destinations.length+" destinations"))},e.addInput=function(t){e.inputText+=t},e.backspace=function(){e.inputText.length>0&&(e.inputText=e.inputText.substr(0,e.inputText.length-1))},e.onAccept=function(){var t=parseInt(e.inputText);isNaN(t)?console.log("Invalid input "+e.inputText):(console.log("Travelling to "+t),W.targetHotspot=t,W.socket.sendMsg({type:6,requestTravel:{targetDestination:t}}),e.state=0),e.inputText=""},e.handleKeyDown=function(t,r){e.state==e.stateRoot?49==r?(e.inputText="",e.setState(e.stateHyperdrive)):50==r?e.setState(e.stateSave):51==r&&e.setState(e.stateLoad):1==e.state?220==r?e.state=0:8==r?e.backspace():13==r?e.onAccept():e.addInput(t):220==r&&(e.state=e.stateRoot)},e.capturedInput=function(){return 1==e.state},e.onmessage=function(t){if(5==t.type){console.log("Got destinations!");for(var r=0;r<t.destinationResponse.destinationIds.length;r++)e.destinations.push({id:t.destinationResponse.destinationIds[r],name:t.destinationResponse.destinationNames[r],numberOfPlayers:t.destinationResponse.destinationPlayerCount[r]})}},e}function n(){var e={};return e.state=1,e.type=1,e.render=function(){1==e.state?$.renderTextAtScreen("LOADING",!0,0,16):2==e.state&&$.renderTextAtScreen("CONNECTING",!0,0,16)},e.capturedInput=function(){return!0},e.onmessage=function(e){var t=e.type;console.log("Loading UI got message "+t)},e}function a(e,t,r){var o={},n=i(e,t),a=i(e,r);return o.id=e.createProgram(),e.attachShader(o.id,n),e.attachShader(o.id,a),e.linkProgram(o.id),e.getProgramParameter(o.id,e.LINK_STATUS)||alert("Could not initialise shaders"),o.shaderAttributes={},o.uniforms={},o.addUniform=function(t){e.useProgram(o.id),o.uniforms[t]=e.getUniformLocation(o.id,t)},o.getUniform=function(e){return o.uniforms[e]},o.addAttribute=function(t){e.useProgram(o.id),o.shaderAttributes[t]=e.getAttribLocation(o.id,t)},o.getAttribute=function(e){return o.shaderAttributes[e]},o.enableVertexAttributeArray=function(t){e.useProgram(o.id),e.enableVertexAttribArray(t)},o.bufferMatrix=function(t,r){e.useProgram(o.id),e.uniformMatrix4fv(o.getUniform(t),!1,r)},o.bufferVec2=function(t,r){e.useProgram(o.id),e.uniform2fv(o.getUniform(t),r)},o}function i(e,t){var r=document.getElementById(t);if(!r)return null;for(var o="",n=r.firstChild;n;)3==n.nodeType&&(o+=n.textContent),n=n.nextSibling;var a;if("x-shader/x-fragment"==r.type)a=e.createShader(e.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=r.type)return null;a=e.createShader(e.VERTEX_SHADER)}return e.shaderSource(a,o),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)?a:(alert(e.getShaderInfoLog(a)),null)}function s(e){var t={};return t.id=e.createBuffer(),console.log("Created Buffer "+t.id),t.bufferFloats=function(r){console.log("Buffer data "+r),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW)},t}function d(t,r){var o={};return o.transform=e(),console.log(t),console.log("Creating sprite"),o.createModel=function(){var e={},t=.5;r&&(t=r),e.vaoId=V.createVertexArray();var n=[-t,-t,t,-t,-t,t,-t,t,t,-t,t,t],a=[0,0,1,0,0,1,0,1,1,0,1,1];e.vertexPositionId=V.createBuffer(),e.uvsPositionId=V.createBuffer(),V.bindVertexArray(e.vaoId);V.enableVertexAttribArray(H.getAttribute("vertexPosition")),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(n),V.STATIC_DRAW),V.vertexAttribPointer(0,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null);return V.enableVertexAttribArray(H.getAttribute("textureCoordinates")),V.bindBuffer(V.ARRAY_BUFFER,e.uvsPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(a),V.STATIC_DRAW),V.vertexAttribPointer(1,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null),console.log(o),e},o.setTilesheetUv=function(e,r,n){var a=r/t.image.width,i=n/t.image.height,s=Math.floor(t.image.width/r),d=e%s,u=Math.floor(e/s),c=d*a,l=(d+1)*a,f=u*i,m=(u+1)*i,h=[c,f,l,f,c,m,c,m,l,f,l,m];V.bindBuffer(V.ARRAY_BUFFER,o.model.uvsPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(h),V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,null)},o.render=function(){var e=G.getViewMatrix(),r=o.transform.position;mat4.translate(e,e,r),H.bufferMatrix("modelview",e),V.useProgram(H.id),V.bindVertexArray(o.model.vaoId),V.uniform1i(H.getUniform("colorMap"),0),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,t.imageId),V.bindBuffer(V.ARRAY_BUFFER,o.model.vertexPositionId),V.vertexAttribPointer(H.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,o.model.uvsPositionId),V.vertexAttribPointer(H.getAttribute("textureCoordinates"),2,V.FLOAT,!1,0,0),V.drawArrays(V.TRIANGLES,0,6),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},o.renderScreenSpace=function(){var e=mat4.create();mat4.ortho(e,-256,256,256,-256,.1,100),H.bufferMatrix("projection",e);var r=mat4.create();mat4.fromTranslation(r,[0,0,-1]),H.bufferMatrix("modelview",r),V.useProgram(H.id),V.bindVertexArray(o.model.vaoId),V.uniform1i(H.getUniform("colorMap"),0),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,t.imageId),V.bindBuffer(V.ARRAY_BUFFER,o.model.vertexPositionId),V.vertexAttribPointer(H.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,o.model.uvsPositionId),V.vertexAttribPointer(H.getAttribute("textureCoordinates"),2,V.FLOAT,!1,0,0),V.drawArrays(V.TRIANGLES,0,6),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null),H.bufferMatrix("projection",G.projectionMatrix)},o.renderScreenSpaceUvOffset=function(){var e=G.transform.position,r=mat4.create();mat4.ortho(r,-256,256,256,-256,.1,100),W.shaders.quadOffsetVertexShader.bufferMatrix("projection",r);var n=mat4.create();mat4.fromTranslation(n,[0,0,-1]),W.shaders.quadOffsetVertexShader.bufferMatrix("modelview",n),W.shaders.quadOffsetVertexShader.bufferVec2("uvOffset",[e[0]/100,e[1]/100]),V.useProgram(W.shaders.quadOffsetVertexShader.id),V.bindVertexArray(o.model.vaoId),V.uniform1i(W.shaders.quadOffsetVertexShader.getUniform("colorMap"),0),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,t.imageId),V.bindBuffer(V.ARRAY_BUFFER,o.model.vertexPositionId),V.vertexAttribPointer(W.shaders.quadOffsetVertexShader.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,o.model.uvsPositionId),V.vertexAttribPointer(W.shaders.quadOffsetVertexShader.getAttribute("textureCoordinates"),2,V.FLOAT,!1,0,0),V.drawArrays(V.TRIANGLES,0,6),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null),W.shaders.quadOffsetVertexShader.bufferMatrix("projection",G.projectionMatrix)},o.model=o.createModel(),o}function u(e,t){var r={};return r.useTexture=null!=t,r.readyTexture=!1,r.createModel=function(){var t={},r=[1,1,-1,1,-1,-1,-1,-1,1,-1,1,1];return t.id=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.id),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW),t},r.render=function(t){r.useTexture&&!r.readyTexture||(e.useProgram(t.id),r.useTexture&&e.bindTexture(e.TEXTURE_2D,r.texID),e.bindBuffer(e.ARRAY_BUFFER,r.model.id),e.vertexAttribPointer(t.getAttribute("vertexPosition"),2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.bindBuffer(e.ARRAY_BUFFER,null))},r.loadTexture=function(){r.image=new Image,r.image.onload=function(){r.texID=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.texID),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r.image),e.generateMipmap(e.TEXTURE_2D),r.readyTexture=!0,console.log("Ready texture: "+t)},r.image.src=t},r.model=r.createModel(),r.useTexture&&r.loadTexture(),r}function c(){var e={};e.name="",e.loadedImages=0,e.blockIndex=0,e.blocks={},e.blocksArray=[],e.width=0,e.height=0,e.minX=0,e.maxX=0,e.minY=0,e.maxY=0;var t=d(W.images.ui);return t.setTilesheetUv(0,64,64),e.createModel=function(){var t={},r=[.5*-e.textureWidth,.5*-e.textureHeight,.5*e.textureWidth,.5*-e.textureHeight,.5*-e.textureWidth,.5*e.textureHeight,.5*-e.textureWidth,.5*e.textureHeight,.5*e.textureWidth,.5*-e.textureHeight,.5*e.textureWidth,.5*e.textureHeight];t.id=V.createBuffer(),V.bindBuffer(V.ARRAY_BUFFER,t.id),V.bufferData(V.ARRAY_BUFFER,new Float32Array(r),V.STATIC_DRAW),t.coordId=V.createBuffer(),V.bindBuffer(V.ARRAY_BUFFER,t.coordId),V.bufferData(V.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),V.STATIC_DRAW),t.vaoId=V.createVertexArray(),V.bindVertexArray(t.vaoId);V.enableVertexAttribArray(j.getAttribute("vertexPosition")),V.bindBuffer(V.ARRAY_BUFFER,t.id),V.vertexAttribPointer(0,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null);return V.enableVertexAttribArray(j.getAttribute("textureCoordinates")),V.bindBuffer(V.ARRAY_BUFFER,t.coordId),V.vertexAttribPointer(1,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null),t},e.render=function(t){if(e.loadedImages<1)console.log("Not rendering");else{var r=G.getViewMatrix();mat4.translate(r,r,e.ship.transform.position),mat4.translate(r,r,[e.shiftX,e.shiftY,0]),t.bufferMatrix("modelview",r),V.useProgram(t.id),V.bindVertexArray(e.model.vaoId),V.uniform1i(t.getUniform("colorMap"),0),V.uniform1i(t.getUniform("blockMap"),1),t.bufferVec2("blockMapDimensions",[e.textureWidth,e.textureHeight]),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D_ARRAY,W.images.blocks.imageId),V.activeTexture(V.TEXTURE1),V.bindTexture(V.TEXTURE_2D,e.framebuffer.textureId),V.bindBuffer(V.ARRAY_BUFFER,e.model.id),V.vertexAttribPointer(t.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,e.model.coordId),V.vertexAttribPointer(t.getAttribute("textureCoordinates"),2,V.FLOAT,!1,0,0),V.drawArrays(V.TRIANGLES,0,6),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null),V.activeTexture(V.TEXTURE0),e.renderSelectedBlock()}},e.renderSelectedBlock=function(){var r=G.getMouseWorldPosition(),o=r[0]-e.ship.transform.position[0],n=r[1]-e.ship.transform.position[1];null!=e.getLocalBlock(Math.round(o),Math.round(n))&&(vec3.set(t.transform.position,e.ship.transform.position[0]+Math.round(o),e.ship.transform.position[1]+Math.round(n),0),t.render())},e.loadFromImageTexture=function(t){e.blockImage=new Image,e.blockImage.onload=function(){e.blockId=V.createTexture(),V.bindTexture(V.TEXTURE_2D,e.blockId),V.texImage2D(V.TEXTURE_2D,0,V.RGBA,V.RGBA,V.UNSIGNED_BYTE,e.blockImage),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MIN_FILTER,V.NEAREST),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MAG_FILTER,V.NEAREST),e.loadedImages++},e.blockImage.src=blockMapName},e.loadFromProtobufBytes=function(t){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(t){var o=W.protoDefinition.Mass,n=new Uint8Array(r.response),a=o.decode(n);e.setupFromProtobuf(a)},r.send(null)},e.loadFromBytes=function(t){var r=W.protoDefinition.Mass,o=new Uint8Array(t),n=r.decode(o);e.setupFromProtobuf(n)},e.getHash=function(e,t){return(e<<16)+t},e.setupFromProtobuf=function(t){e.blockIndex=0,e.width=0,e.height=0,e.minX=0,e.maxX=0,e.minY=0,e.maxY=0,e.name=t.name;var r=t.blocks;if(r)for(var o=r.length-1;o>=0;o--){var n=r[o],a=n.type||0;n.type=a;var i=n.x||0;n.x=i;var s=n.y||0;n.y=s;var d=e.getHash(i,s);n.index=e.blockIndex,e.blocks[d]=e.blockIndex,e.blocksArray.push(n),e.blockIndex++,i>e.maxX&&(e.maxX=i),i<e.minX&&(e.minX=i),s>e.maxY&&(e.maxY=s),s<e.minY&&(e.minY=s)}e.width=e.maxX-e.minX+1,e.height=e.maxY-e.minY+1,e.createFramebuffer()},e.createFramebuffer=function(){console.log("width/height 1 "+e.textureWidth+" "+e.textureHeight+" from "+e.width+" "+e.height);var t=Math.max(Math.abs(e.minX),e.maxX),r=Math.max(Math.abs(e.minY),e.maxY);e.textureWidth=Math.pow(2,Math.ceil(Math.log(2*t+1)/Math.log(2))),e.textureHeight=Math.pow(2,Math.ceil(Math.log(2*r+1)/Math.log(2))),console.log("width/height 2 "+e.textureWidth+" "+e.textureHeight);e.width,e.minX,e.height,e.minY;e.shiftX=.5,e.shiftY=.5,e.framebuffer=f(e.textureWidth,e.textureHeight);for(var o=[],n=[],a=1/(.5*e.textureWidth),i=1/(.5*e.textureHeight),s=e.blocksArray.length-1;s>=0;s--){var d=e.blocksArray[s],u=d.x*a,c=d.y*i;o.push(u),o.push(c),n.push(d.type*(1/255)),n.push(0),n.push(0),n.push(1)}W.pointRenderer.bufferPoints(o,n),e.framebuffer.bind(),V.clear(V.COLOR_BUFFER_BIT),W.pointRenderer.render(),e.framebuffer.unbind(),e.model=e.createModel(),e.loadedImages++},e.destroyFramebuffer=function(){},e.downloadShip=function(){for(var t=W.protoDefinition.Mass,r={name:e.name,blocks:[]},o=e.blocksArray.length-1;o>=0;o--){var n=e.blocksArray[o];r.blocks.push(n)}var a=t.verify(r);if(a)throw Error(a);var i=t.create(r),s=t.encode(i).finish();saveAs(new Blob([s],{type:"example/binary"}),"data.dat")},e.canMoveTo=function(t,r){var o=e.getLocalBlock(Math.round(t),Math.round(r));return null!=o&&3==o.type},e.blocksShot=function(t,r){var o=e.getLocalBlock(Math.round(t),Math.round(r));return null!=o&&3!=o.type},e.worldToLocalX=function(t){var r=t-e.ship.transform.position[0];return Math.round(r)},e.worldToLocalY=function(t){var r=t-e.ship.transform.position[1];return Math.round(r)},e.getBlock=function(t,r){var o=e.worldToLocalX(t),n=e.worldToLocalY(r);return e.getLocalBlock(o,n)},e.getLocalBlock=function(t,r){var o=e.getHash(t,r),n=e.blocks[o];return null==n?null:e.blocksArray[n]},e.addBlock=function(t,r,o){if(null!=e.getBlock(r,o))console.log("Cannot add block there, already something there");else{var n=e.worldToLocalX(r),a=e.worldToLocalY(o);e.createBlock(t,n,a)}},e.createBlock=function(t,r,o){var n={type:t,x:r,y:o,index:e.blockIndex};e.blockIndex++,e.blocksArray.push(n);var a=e.getHash(r,o);e.blocks[a]=n.index,r>e.maxX&&(e.maxX=r),r<e.minX&&(e.minX=r),o>e.maxY&&(e.maxY=o),o<e.minY&&(e.minY=o),e.width=e.maxX-e.minX+1,e.height=e.maxY-e.minY+1;var i=r*(1/(.5*e.textureWidth)),s=o*(1/(.5*e.textureHeight));Math.max(Math.abs(e.minX),e.maxX),Math.max(Math.abs(e.minY),e.maxY);if(i>-1&&i<=1&&s>-1&&s<=1){var d=[],u=[];d.push(i),d.push(s),u.push(n.type*(1/255)),u.push(0),u.push(0),u.push(1),W.pointRenderer.bufferPoints(d,u),e.framebuffer.bind(),W.pointRenderer.render(),e.framebuffer.unbind()}else e.framebuffer.destroy(),e.createFramebuffer()},e.raycast=function(t,r){t.distance=r,t.hit=!1;for(var o=4*Math.ceil(r),n=t.origin,a=t.direction,i=0;i<o;i++){var s=e.worldToLocalX(n[0]+a[0]*i*.25),d=e.worldToLocalY(n[1]+a[1]*i*.25);if(e.blocksShot(s,d)){var u=vec2.create();return vec2.scale(u,a,.25*i),t.distance=vec2.squaredLength(u),void(t.hit=!0)}}},e}function l(e){var t={};return t.readyGeometry=!1,t.readyTextures=!1,t.model=function(r){var o={};return o.coordsBuffer=e.createBuffer(),o.indexBuffer=e.createBuffer(),o.count=r.indices.length,e.bindBuffer(e.ARRAY_BUFFER,o.coordsBuffer),e.bufferData(e.ARRAY_BUFFER,r.vertexPositions,e.STATIC_DRAW),console.log("buffer vertices: "+r.vertexPositions.length),console.log("buffer indecies: "+r.indices.length),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r.indices,e.STATIC_DRAW),t.readyGeometry=!0,o.render=function(){e.drawElements(e.TRIANGLES,o.count,e.UNSIGNED_SHORT,0)},o}(cube(50)),function(r){for(var o=0,n=new Array(6),a=0;a<6;a++)n[a]=new Image,n[a].onload=function(){if(6==++o){t.texID=e.createTexture(),e.bindTexture(e.TEXTURE_CUBE_MAP,t.texID);for(var r=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z],a=0;a<6;a++)e.texImage2D(r[a],0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n[a]),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.generateMipmap(e.TEXTURE_CUBE_MAP),t.readyTextures=!0,console.log("Ready textures")}},n[a].src=r[a]}(["images/skyposx1.png","images/skynegx1.png","images/skyposy1.png","images/skynegy1.png","images/skyposz1.png","images/skynegz1.png"]),t.render=function(r){if(t.readyTextures&&t.readyGeometry){e.useProgram(r.id),e.bindTexture(e.TEXTURE_CUBE_MAP,t.texID),e.bindBuffer(e.ARRAY_BUFFER,t.model.coordsBuffer),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.model.indexBuffer),e.vertexAttribPointer(r.getAttribute("coords"),3,e.FLOAT,!1,0,0);var o=mat4.create();mat4.fromQuat(o,G.transform.rotation),r.bufferMatrix("modelview",o),t.model.render()}else console.log("Not yet ready")},t}function f(e,t){var r={};return r.width=e,r.height=t,r.createTexture=function(){r.textureId=V.createTexture(),V.bindTexture(V.TEXTURE_2D,r.textureId),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_WRAP_S,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_WRAP_T,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MIN_FILTER,V.NEAREST),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MAG_FILTER,V.NEAREST),V.texImage2D(V.TEXTURE_2D,0,V.RGBA,r.width,r.height,0,V.RGBA,V.UNSIGNED_BYTE,null),V.bindTexture(V.TEXTURE_2D,null)},r.createFrameBuffer=function(){r.id=V.createFramebuffer(),V.bindFramebuffer(V.FRAMEBUFFER,r.id),V.framebufferTexture2D(V.FRAMEBUFFER,V.COLOR_ATTACHMENT0,V.TEXTURE_2D,r.textureId,0),V.bindFramebuffer(V.FRAMEBUFFER,null)},r.bind=function(){V.bindFramebuffer(V.FRAMEBUFFER,r.id),V.viewport(0,0,r.width,r.height)},r.unbind=function(){V.bindFramebuffer(V.FRAMEBUFFER,null),V.viewport(0,0,O.width,O.height)},r.destroy=function(){console.log("Destroying framebuffer "+r.id),V.deleteFramebuffer(r.id),V.deleteTexture(r.textureId)},r.createTexture(),r.createFrameBuffer(),console.log("Created framebuffer: "+r.textureId+" ["+e+"x"+t+"]"),r}function m(){var e={};return e.count=0,e.createBuffers=function(){e.vertexPositionId=V.createBuffer(),e.colorPositionId=V.createBuffer(),e.vaoId=V.createVertexArray(),V.bindVertexArray(e.vaoId);V.enableVertexAttribArray(W.shaders.points.getAttribute("vertexPosition")),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.vertexAttribPointer(0,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null);V.enableVertexAttribArray(W.shaders.points.getAttribute("colorPosition")),V.bindBuffer(V.ARRAY_BUFFER,e.colorPositionId),V.vertexAttribPointer(1,4,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},e.bufferPoints=function(t,r){V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(t),V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,e.colorPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(r),V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,null),e.count=Math.floor(t.length/2)},e.render=function(){V.useProgram(W.shaders.points.id),V.bindVertexArray(e.vaoId),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.vertexAttribPointer(W.shaders.points.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,e.colorPositionId),V.vertexAttribPointer(W.shaders.points.getAttribute("colorPosition"),4,V.FLOAT,!1,0,0),V.drawArrays(V.POINTS,0,e.count),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},e.createBuffers(),e}function h(){var e={};e.cachedText={};var t=H;e.createTexture=function(){e.vaoId=V.createVertexArray(),e.vertexPositionId=V.createBuffer(),e.uvsPositionId=V.createBuffer(),V.bindVertexArray(e.vaoId);V.enableVertexAttribArray(t.getAttribute("vertexPosition")),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.vertexAttribPointer(0,2,V.FLOAT,!1,0,0);V.enableVertexAttribArray(t.getAttribute("textureCoordinates")),V.bindBuffer(V.ARRAY_BUFFER,e.uvsPositionId),V.vertexAttribPointer(1,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},e.renderText=function(r,o){r=r.toLowerCase();var n;e.cachedText[r]?n=e.cachedText[r]:(n=e.makeVerticesForString(r),o&&(e.cachedText[r]=n));var a=G.getViewMatrix(),i=astronaut.transform.position;mat4.translate(a,a,i),mat4.scale(a,a,[.03125,-.03125,.03125]),t.bufferMatrix("modelview",a),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.bufferData(V.ARRAY_BUFFER,n.arrays.position,V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,e.uvsPositionId),V.bufferData(V.ARRAY_BUFFER,n.arrays.texcoord,V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,null),V.useProgram(t.id),V.bindVertexArray(e.vaoId),V.uniform1i(t.getUniform("colorMap"),0),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,W.images.font.imageId),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.vertexAttribPointer(t.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,e.uvsPositionId),V.vertexAttribPointer(t.getAttribute("textureCoordinates"),2,V.FLOAT,!1,0,0),V.drawArrays(V.TRIANGLES,0,n.numVertices),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},e.renderTextAtScreen=function(r,o,n,a){r=r.toLowerCase();var i;e.cachedText[r]?i=e.cachedText[r]:(i=e.makeVerticesForString(r),o&&(e.cachedText[r]=i));G.transform.position;var s=mat4.create(),d=.5*O.width,u=.5*O.height;mat4.ortho(s,-d,d,-u,u,.1,100),t.bufferMatrix("projection",s);var c=mat4.create();mat4.fromTranslation(c,[-d+n,-u+a,-1]),t.bufferMatrix("modelview",c),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.bufferData(V.ARRAY_BUFFER,i.arrays.position,V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,e.uvsPositionId),V.bufferData(V.ARRAY_BUFFER,i.arrays.texcoord,V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,null),V.useProgram(t.id),V.bindVertexArray(e.vaoId),V.uniform1i(t.getUniform("colorMap"),0),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,W.images.font.imageId),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.vertexAttribPointer(t.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,e.uvsPositionId),V.vertexAttribPointer(t.getAttribute("textureCoordinates"),2,V.FLOAT,!1,0,0),V.drawArrays(V.TRIANGLES,0,i.numVertices),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null),t.bufferMatrix("projection",G.projectionMatrix)};var r={letterHeight:8,spaceWidth:8,spacing:-1,textureWidth:64,textureHeight:40,glyphInfos:{a:{x:0,y:0,width:8},b:{x:8,y:0,width:8},c:{x:16,y:0,width:8},d:{x:24,y:0,width:8},e:{x:32,y:0,width:8},f:{x:40,y:0,width:8},g:{x:48,y:0,width:8},h:{x:56,y:0,width:8},i:{x:0,y:8,width:8},j:{x:8,y:8,width:8},k:{x:16,y:8,width:8},l:{x:24,y:8,width:8},m:{x:32,y:8,width:8},n:{x:40,y:8,width:8},o:{x:48,y:8,width:8},p:{x:56,y:8,width:8},q:{x:0,y:16,width:8},r:{x:8,y:16,width:8},s:{x:16,y:16,width:8},t:{x:24,y:16,width:8},u:{x:32,y:16,width:8},v:{x:40,y:16,width:8},w:{x:48,y:16,width:8},x:{x:56,y:16,width:8},y:{x:0,y:24,width:8},z:{x:8,y:24,width:8},0:{x:16,y:24,width:8},1:{x:24,y:24,width:8},2:{x:32,y:24,width:8},3:{x:40,y:24,width:8},4:{x:48,y:24,width:8},5:{x:56,y:24,width:8},6:{x:0,y:32,width:8},7:{x:8,y:32,width:8},8:{x:16,y:32,width:8},9:{x:24,y:32,width:8},"-":{x:32,y:32,width:8},"*":{x:40,y:32,width:8},"!":{x:48,y:32,width:8},"?":{x:56,y:32,width:8}}};return e.makeVerticesForString=function(e){for(var t=e.length,o=6*t,n=new Float32Array(2*o),a=new Float32Array(2*o),i=0,s=0,d=r.textureWidth,u=r.textureHeight,c=0;c<t;++c){var l=e[c],f=r.glyphInfos[l];if(f){var m=s+f.width,h=f.x/d,p=(f.y+r.letterHeight-1)/u,g=(f.x+f.width-1)/d,A=f.y/u;n[i+0]=s,n[i+1]=0,a[i+0]=h,a[i+1]=p,n[i+2]=m,n[i+3]=0,a[i+2]=g,a[i+3]=p,n[i+4]=s,n[i+5]=r.letterHeight,a[i+4]=h,a[i+5]=A,n[i+6]=s,n[i+7]=r.letterHeight,a[i+6]=h,a[i+7]=A,n[i+8]=m,n[i+9]=0,a[i+8]=g,a[i+9]=p,n[i+10]=m,n[i+11]=r.letterHeight,a[i+10]=g,a[i+11]=A,s+=f.width+r.spacing,i+=12}else s+=r.spaceWidth}return{arrays:{position:new Float32Array(n.buffer,0,i),texcoord:new Float32Array(a.buffer,0,i)},numVertices:i/2}},e.createTexture(),e}function p(){var e={};return e.createBuffers=function(){e.vertexPositionId=V.createBuffer(),e.colorPositionId=V.createBuffer(),e.vaoId=V.createVertexArray(),V.bindVertexArray(e.vaoId);V.enableVertexAttribArray(W.shaders.lines.getAttribute("vertexPosition")),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.vertexAttribPointer(0,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null);V.enableVertexAttribArray(W.shaders.lines.getAttribute("colorPosition")),V.bindBuffer(V.ARRAY_BUFFER,e.colorPositionId),V.vertexAttribPointer(1,4,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},e.bufferPoints=function(t,r){V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(t),V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,e.colorPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(r),V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,null),e.count=Math.floor(t.length/2)},e.render=function(){V.useProgram(W.shaders.lines.id),V.bindVertexArray(e.vaoId);var t=G.getViewMatrix();W.shaders.lines.bufferMatrix("modelview",t),V.drawArrays(V.LINES,0,e.count),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},e.createBuffers(),e}function g(){var t={};return t.id=0,t.ship=null,t.transform=e(),t.rotZ=0,t.createModel=function(){var e={};e.vaoId=V.createVertexArray();var r=[-.25,-.25,.25,-.25,-.25,.25,-.25,.25,.25,-.25,.25,.25],o=[0,0,1,0,0,1,0,1,1,0,1,1];e.vertexPositionId=V.createBuffer(),e.uvsPositionId=V.createBuffer(),V.bindVertexArray(e.vaoId);V.enableVertexAttribArray(H.getAttribute("vertexPosition")),V.bindBuffer(V.ARRAY_BUFFER,e.vertexPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(r),V.STATIC_DRAW),V.vertexAttribPointer(0,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null);return V.enableVertexAttribArray(H.getAttribute("textureCoordinates")),V.bindBuffer(V.ARRAY_BUFFER,e.uvsPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(o),V.STATIC_DRAW),V.vertexAttribPointer(1,2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null),console.log(t),e},t.update=function(){t.mainPlayer&&(t.checkSendUpdateTransform(),t.ship?vec3.set(G.transform.position,t.ship.transform.position[0]+t.transform.position[0],t.ship.transform.position[1]+t.transform.position[1],-10):vec3.set(G.transform.position,t.transform.position[0],t.transform.position[1],-10))},t.render=function(){var e=G.getViewMatrix();t.ship&&mat4.translate(e,e,t.ship.transform.position),mat4.translate(e,e,t.transform.position);var r=Math.PI/180;if(t.mainPlayer){var o=G.getMouseWorldPosition(),n=vec3.create();vec3.add(n,o,t.transform.getNegativePosition()),t.ship&&vec3.add(n,n,t.ship.transform.getNegativePosition()),vec3.normalize(n,n);var a=Math.atan2(n[1],n[0]);t.rotZ=a,mat4.rotateZ(e,e,t.rotZ+90*r)}else mat4.rotateZ(e,e,t.rotZ+90*r);H.bufferMatrix("modelview",e),V.useProgram(H.id),V.bindVertexArray(t.model.vaoId),V.uniform1i(H.getUniform("colorMap"),0),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,W.images.astronaut.imageId),V.bindBuffer(V.ARRAY_BUFFER,t.model.vertexPositionId),V.vertexAttribPointer(H.getAttribute("vertexPosition"),2,V.FLOAT,!1,0,0),V.bindBuffer(V.ARRAY_BUFFER,t.model.uvsPositionId),V.vertexAttribPointer(H.getAttribute("textureCoordinates"),2,V.FLOAT,!1,0,0),V.drawArrays(V.TRIANGLES,0,6),V.bindBuffer(V.ARRAY_BUFFER,null),V.bindVertexArray(null)},t.setFrame=function(e){var r=e%16,o=Math.floor(e/16),n=.0625*r,a=.0625*(r+1),i=.0625*o,s=.0625*(o+1),d=[n,i,a,i,n,s,n,s,a,i,a,s];V.bindBuffer(V.ARRAY_BUFFER,t.model.uvsPositionId),V.bufferData(V.ARRAY_BUFFER,new Float32Array(d),V.STATIC_DRAW),V.bindBuffer(V.ARRAY_BUFFER,null)},t.move=function(e,r){var o=.1*r,n=-.1*e,a=t.transform.position[0]+o,i=t.transform.position[1]+n,s=!0;t.ship&&(s=t.ship.blockRenderer.canMoveTo(a,i)),s&&t.transform.addPosition([o,n,0])},t.checkSendUpdateTransform=function(){if(t.mainPlayer)if(t.lastSentUpdate){var e=Date.now();e-t.lastSentUpdate>500&&(t.lastSentUpdate=e,t.sendUpdateTransform())}else t.lastSentUpdate=Date.now(),t.sendUpdateTransform()},t.sendUpdateTransform=function(){if(W.gameSocket){var e=t.transform.position,r={type:10,updatePlayerTransform:{identity:t.id,x:e[0],y:e[1],rotationZ:t.rotZ}};W.gameSocket.sendMsg(r)}},t.checkSendSteerShip=function(e,r){if(t.mainPlayer)if(t.ship&&(t.ship.steering[0]=e,t.ship.steering[1]=r),0==e&&0==r)t.hasStartedDriving&&(t.hasStartedDriving=!1,t.sendSteerShip(e,r));else if(t.hasStartedDriving=!0,t.lastSentSteer){var o=Date.now();o-t.lastSentSteer>30&&(t.lastSentSteer=o,t.sendSteerShip(e,r))}else t.lastSentSteer=Date.now(),t.sendSteerShip(e,r)},t.sendSteerShip=function(e,r){var o={type:12,steerShip:{identity:t.id,shipId:t.ship.id,dx:e,dy:r}};W.gameSocket.sendMsg(o)},t.updateTransform=function(e){t.transform.position=[e.x,e.y,0],t.rotZ=e.rotationZ,e.attachedShip&&W.hotspot?t.ship=W.hotspot.getShip(e.attachedShip):null==e.attachedShip&&W.hotspot},t.isDriving=function(){return null!=t.ship},t.model=t.createModel(),t}function A(t){var r={};return r.id=0,r.blockRenderer=t,t.ship=r,r.transform=e(),r.velocity=[0,0],r.steering=[0,0],r.createdAt=new Date,r.update=function(){if(Math.abs(r.steering[0])>0||Math.abs(r.steering[1])>0){r.velocity[0]+=5*r.steering[0]*W.time.deltaTime,r.velocity[1]+=5*r.steering[1]*W.time.deltaTime}var e=r.velocity[0]*W.time.deltaTime,t=r.velocity[1]*W.time.deltaTime;(Math.abs(e)>0||Math.abs(t)>0)&&r.transform.addPosition([e,t,0])},r.render=function(){},r.secondsSinceCreated=function(){return(new Date-r.createdAt)/1e3},r}function R(){var e={};return e.locked=!1,e.fpsControls=!1,e.lastX=0,e.lastY=0,O.addEventListener("mousemove",function(t){if(e.locked)if(e.fpsControls){var r=t.movementX||t.mozMovementX||t.webkitMovementX||0,o=t.movementY||t.mozMovementY||t.webkitMovementY||0,n=.05*r;G.yaw+=n;a=.05*o;G.pitch+=a,G.pitch>90?G.pitch=90:G.pitch<-90&&(G.pitch=-90);var a=quat.create();quat.setAxisAngle(a,[1,0,0],glMatrix.toRadian(G.pitch));n=quat.create();quat.setAxisAngle(n,[0,1,0],glMatrix.toRadian(G.yaw));var i=quat.create();quat.mul(i,a,n),quat.normalize(i,i),quat.copy(G.transform.rotation,i)}else console.log("Mouse locked, but no fps controls");else x(O,t)},!1),document.addEventListener("pointerlockchange",function(t){console.log("pointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("mozpointerlockchange",function(t){console.log("mozpointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("webkitpointerlockchange",function(t){console.log("webkitpointerlockchange "+t),e.onLockChanged(t)},!1),document.addEventListener("pointerlockerror",function(e){console.log("pointerlockerror "+e)},!1),document.addEventListener("mozpointerlockerror",function(e){console.log("mozpointerlockerror "+e)},!1),document.addEventListener("webkitpointerlockerror",function(e){console.log("webkitpointerlockerror "+e)},!1),O.addEventListener("click",function(t){if(e.fpsControls&&!e.locked&&e.canLock())console.log("Clicked on canvas, trying to lock"),e.lock();else{var r=G.getMouseWorldPosition();if(W.hotspot){var o=W.hotspot.getMainPlayer(),n=o.transform.position[0],a=o.transform.position[1],i=r[0],s=r[1];if(o.ship){n+=o.ship.transform.position[0],a+=o.ship.transform.position[1];var d={origin:vec2.fromValues(n,a),direction:vec2.fromValues(i,s)};if(vec2.add(d.direction,d.direction,vec2.fromValues(-n,-a)),vec2.normalize(d.direction,d.direction),o.ship.blockRenderer.raycast(d,25),console.log("Hit ship? "+d.hit+": "+d.distance),d.hit){vec2.fromValues(n,a);var u=vec2.create();vec2.copy(u,d.direction),vec2.scale(u,u,d.distance),i=n+u[0],s=a+u[1],console.log("Final "+i+" "+s)}}W.hotspot.createProjectile(W.hotspot.getMainPlayerId(),1,n,a,i,s)}}},!1),e.update=function(){},e.canLock=function(){var e="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;return console.log("Can mouse lock: "+e),e},e.lock=function(){console.log("Trying to lock"),O.requestPointerLock=O.requestPointerLock||O.mozRequestPointerLock||O.webkitRequestPointerLock,O.requestPointerLock()},e.unlock=function(){console.log("Trying to unlock"),document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()},e.onLockChanged=function(t){document.pointerLockElement===O||document.mozPointerLockElement===O||document.webkitPointerLockElement===O?(console.log("enabled lock"),e.locked=!0):(console.log("disabled lock"),e.locked=!1)},e}function x(e,t){var r=e.getBoundingClientRect();z.lastX=t.clientX-r.left,z.lastY=t.clientY-r.top}function v(){var e={},t="ongamepadconnected"in window;e.controllers={};return e.connecthandler=function(t){e.addgamepad(t.gamepad)},e.addgamepad=function(t){console.log("Add gamepad "+t.id),e.controllers[t.index]=t},e.disconnecthandler=function(t){e.removegamepad(t.gamepad)},e.removegamepad=function(t){delete e.controllers[t.index]},e.update=function(){if(e.controllers.length<=0){if(!(Date.now()-0>500))return;e.scangamepads()}e.scangamepads();var t,r=0;for(t in e.controllers){var o=e.controllers[t];for(r=0;r<o.buttons.length;r++){var n=o.buttons[r],a=1==n.pressed,i=n.value;(a||i>0)&&console.log("Button pressed "+i+" "+a+" "+n)}for(r=0;r<o.axes.length;r++)o.axes[r]}},e.scangamepads=function(){for(var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],r=0;r<t.length;r++)t[r]&&(t[r].index in e.controllers?e.controllers[t[r].index]=t[r]:e.addgamepad(t[r]))},window.addEventListener("gamepadconnected",e.connecthandler),window.addEventListener("gamepaddisconnected",e.disconnecthandler),t||e.scangamepads(),e}function b(){var e={};return document.onkeydown=E,document.onkeyup=y,e.update=function(){e.topDownControls()},e.uiCapturedInput=function(){for(var e=W.ui.stack.length-1;e>=0;e--)if(W.ui.stack[e].capturedInput&&W.ui.stack[e].capturedInput())return!0;return!1},e.topDownControls=function(){if(!e.uiCapturedInput()){var t=0;t+=T("W")?1:0,t-=T("S")?1:0;var r=0;if(r+=T("D")?1:0,r-=T("A")?1:0,W.hotspot){W.hotspot.moveMainPlayer(t,r);var o=W.hotspot.getMainPlayer();if(o&&o.isDriving()){var n=0,a=0;X[97]&&(n+=-.5,a+=.5),X[100]&&(n+=-1),X[103]&&(n+=-.5,a+=-.5),X[99]&&(n+=.5,a+=.5),X[102]&&(n+=1),X[105]&&(n+=.5,a+=-.5),X[104]&&(a+=-1),X[98]&&(a+=1),o.checkSendSteerShip(n,a)}}var i=0;i+=T("X")?1:0,((i-=T("Z")?1:0)<0||i>0)&&G.addOrtho(i)}},e.fpsControls=function(){var e=vec3.create(),t=vec3.create(),r=quat.create();quat.invert(r,G.transform.rotation),vec3.transformQuat(t,[0,0,1],r),quat.copy(e,t);var o=0;o+=T("W")?1:0,o-=T("S")?1:0,e[1]=0,vec3.normalize(e,e),vec3.scale(e,e,.1*o),G.transform.addPosition(e);var n=vec3.create();vec3.cross(n,t,[0,1,0]);var a=0;a+=T("D")?1:0,a-=T("A")?1:0,n[1]=0,vec3.normalize(n,n),vec3.scale(n,n,.1*a),G.transform.addPosition(n)},e}function T(e){return!!Y[e]&&1==Y[e]}function E(e){Y[String.fromCharCode(e.keyCode)]=!0,X[e.keyCode]=!0;for(var t=0,r=W.ui.stack.length;t<r;t++){var o=W.ui.stack[t];o&&o.handleKeyDown&&o.handleKeyDown(String.fromCharCode(e.keyCode),e.keyCode)}}function y(e){Y[String.fromCharCode(e.keyCode)]=!1,X[e.keyCode]=!1}function F(){var t={};return t.projectionMatrix=mat4.create(),t.transform=e(),t.yaw=0,t.pitch=0,t.translation=mat4.create(),t.rotation=mat4.create(),t.viewMatrix=mat4.create(),t.mouseWorldPosition=vec3.create(),t.aspectRatio=1,t.minOrtho=2,t.maxOrtho=20,t.orthographicSize=10,t.orthoLeft=0,t.orthoRight=0,t.orthoTop=0,t.orthoBottom=0,t.shadersThatHasProjectionMatrix=[],t.setResolution=function(e,r){t.aspectRatio=e/r,console.log("Setting resolution "+e+" "+r+": "+t.aspectRatio)},t.setOrthographicSize=function(e){t.orthographicSize=e;var r=1/t.aspectRatio;t.orthographic(-t.orthographicSize*r,t.orthographicSize*r,t.orthographicSize,-t.orthographicSize,.1,100)},t.addOrtho=function(e){var r=t.orthographicSize+e;r<t.minOrtho?r=t.minOrtho:r>t.maxOrtho&&(r=t.maxOrtho),t.setOrthographicSize(r)},t.perspective=function(e,r,o,n){mat4.perspective(t.projectionMatrix,e,r,o,n)},t.orthographic=function(e,r,o,n,a,i){t.orthoLeft=e,t.orthoRight=r,t.orthoTop=n,t.orthoBottom=o,mat4.ortho(t.projectionMatrix,e,r,o,n,a,i);for(var s=t.shadersThatHasProjectionMatrix.length-1;s>=0;s--)t.shadersThatHasProjectionMatrix[s].bufferMatrix("projection",t.projectionMatrix)},t.getViewMatrix=function(){mat4.identity(t.viewMatrix);var e=t.transform.getNegativePosition();return e[2]=-e[2],mat4.fromTranslation(t.translation,e),mat4.fromQuat(t.rotation,t.transform.rotation),mat4.mul(t.viewMatrix,t.rotation,t.translation),t.viewMatrix},t.getMouseWorldPosition=function(){var e=z.lastX,r=z.lastY,o=O.width,n=O.height;return e=(e-.5*o)/o*2,r=(r-.5*n)/n*2,e*=e<0?-t.orthoLeft:t.orthoRight,r*=r<0?t.orthoBottom:-t.orthoTop,vec3.set(t.mouseWorldPosition,e+t.transform.position[0],r+t.transform.position[1],0),t.mouseWorldPosition},t}function P(e,t){var o=new WebSocket(e);return o.binaryType="arraybuffer",o.authenticated=!1,o.toFlush=[],o.onopen=function(e){console.log("WebSocket Game: On connected"),o.sendMsg({type:3})},o.onmessage=function(e){var r=new Uint8Array(e.data),n=t.decode(r);o.authenticated?o.toFlush.push(n):2==n.type||3==n.type?o.messageMap[n.type](n):console.log("WebSocket Game: Got message before authenticated "+n.type)},o.flush=function(){var e=o.toFlush.length;if(!(e<=0)){for(var t=0;t<e;t++){var r=o.toFlush[t];o.messageMap[r.type]?o.messageMap[r.type](r):console.log("WebSocket Game: Could not find func map for msg "+r.type)}for(;o.toFlush.length>0;)o.toFlush.pop()}},o.gotAuthenticate=function(e){1==e.authenticateResponse.statusCode?(console.log("WebSocket Game: Successfully authenticated"),o.authenticated=!0,o.sendMsg({type:4,requestHotspot:{hotspotId:W.targetHotspot}})):(console.log("WebSocket Game: Could not authenticate "+e.authenticateResponse.statusCode),o.authenticated=!1)},o.gotAuthenticateResponse=function(e){o.sendMsg({type:1,authenticate:{playerId:parseInt(W.account.playerId),token:W.account.token}})},o.gotIdentity=function(e){var t=e.identity.identity,o=e.identity.hotspotId;W.hotspot&&console.log("WebSocket Game Error: already have hotspot "+W.hotspot.id),W.hotspot=r(o,t)},o.gotCreatePlayer=function(e){W.hotspot?W.hotspot.createPlayer(e.createPlayer):console.log("WebSocket Game: no hotspot to gotCreatePlayer")},o.gotRemovePlayer=function(e){W.hotspot?W.hotspot.removePlayer(e.removePlayer):console.log("WebSocket Game: no hotspot to gotRemovePlayer")},o.gotCreateShip=function(e){W.hotspot?W.hotspot.createShip(e.createShip):console.log("WebSocket Game: no hotspot to gotCreateShip")},o.gotRemoveShip=function(e){W.hotspot?W.hotspot.removeShip(e.removeShip):console.log("WebSocket Game: no hotspot to gotRemoveShip")},o.gotUpdatePlayerTransform=function(e){W.hotspot?W.hotspot.updatePlayerTransform(e.updatePlayerTransform):console.log("WebSocket Game: no hotspot to gotUpdatePlayerTransform")},o.gotUpdateShipTransform=function(e){W.hotspot?W.hotspot.updateShipTransform(e.updateShipTransform):console.log("WebSocket Game: no hotspot to gotUpdateShipTransform")},o.messageMap={},o.messageMap[2]=o.gotAuthenticate,o.messageMap[3]=o.gotAuthenticateResponse,o.messageMap[5]=o.gotIdentity,o.messageMap[6]=o.gotCreatePlayer,o.messageMap[7]=o.gotRemovePlayer,o.messageMap[8]=o.gotCreateShip,o.messageMap[9]=o.gotRemoveShip,o.messageMap[10]=o.gotUpdatePlayerTransform,o.messageMap[11]=o.gotUpdateShipTransform,o.sendMsg=function(e){if(o.readyState!==o.CLOSED&&o.readyState!==o.CLOSING){var r=t.verify(e);if(r)console.error("WebSocket Game: Invalid msg "+e+" "+r);else{var n=t.create(e),a=t.encode(n).finish();o.send(a)}}else console.error("WebSocket Game: invalid state to send msg: "+o.readyState)},o}function S(e,t){var r=new WebSocket(e);return r.binaryType="arraybuffer",r.authenticated=!1,r.onopen=function(e){console.log("WebSocket: On connected"),r.sendMsg({type:3})},r.onmessage=function(e){console.log("WebSocket: Got message "+e+" "+e.data+" "+e.data.byteLength),console.log(e.data);var o=new Uint8Array(e.data),n=t.decode(o);if(r.authenticated){if(console.log("WebSocket: Authenticated, handling "+n.type),7==n.type){W.gameSocket&&console.log("WebSocket: Already connected to game server");var a=n.requestTravelResponse,i="wss:"+a.serverAddress;W.debug&&(i="ws:"+a.serverAddress),W.gameSocket=P(i,W.protoDefinition.GameBase)}for(var s=0,d=W.ui.stack.length;s<d;s++){var u=W.ui.stack[s];u&&u.onmessage&&u.onmessage(n)}}else if(3==n.type)if(W.account.token)r.sendMsg({type:1,authenticate:{playerId:parseInt(W.account.playerId),token:W.account.token}});else if(W.account.google){c=W.account.googleUser.getAuthResponse().id_token;r.sendMsg({type:8,googleSignIn:{token:c}})}else console.error("No way of signing in.. stuck");else if(2==n.type)1==n.authenticateResponse.statusCode?(console.log("WebSocket: Successfully authenticated"),r.authenticated=!0,W.account.backend={}):(console.log("WebSocket: Could not authenticate "+n.authenticateResponse.statusCode),r.authenticated=!1);else if(9==n.type)if(console.log("sign in response:"),console.log(n.signInResponse),1==n.signInResponse.statusCode)r.authenticated=!0,W.account.backend={},W.account.setCookie("token",n.signInResponse.token,365),W.account.setCookie("playerId",n.signInResponse.playerId,365);else{var c=W.account.googleUser.getAuthResponse().id_token;r.sendMsg({type:10,register:{googleToken:c,username:"UNKNOWN"}})}else 11==n.type&&(1==n.signInResponse.statusCode?(r.authenticated=!0,W.account.backend={},W.account.setCookie("token",n.signInResponse.token,365),W.account.setCookie("playerId",n.signInResponse.playerId,365)):console.error("ERROR: could not sign in with google or register new user with google"))},r.sendMsg=function(e){var o=t.verify(e);if(o)return console.log("WebSocket: Invalid msg "+o),void console.log(e);var n=t.create(e),a=t.encode(n).finish();console.log("WebSocket: Sending "+a.byteLength+" bytes"),r.send(a)},r}function _(e){W.protoDefinition={},W.images={};var t={};return t.nextId=1,t.queue=[],t.createLoader=function(e){var r={};return r.done=!1,r.id=t.nextId,t.nextId++,r.loadFunc=e,r},t.loadAll=function(){for(var e=t.queue.length-1;e>=0;e--)t.queue[e].loadFunc()},t.loadTexture=function(e,r,o,n,a,i){var s=t.createLoader(function(){var d=new Image;W.images[r]={},W.images[r].image=d,d.onload=function(){var e=V.createTexture();W.images[r].imageId=e,V.bindTexture(V.TEXTURE_2D,e),V.texImage2D(V.TEXTURE_2D,0,V.RGBA,V.RGBA,V.UNSIGNED_BYTE,d),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MIN_FILTER,o),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_MAG_FILTER,n),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_WRAP_S,i),V.texParameteri(V.TEXTURE_2D,V.TEXTURE_WRAP_T,i),a&&V.generateMipmap(V.TEXTURE_2D),console.log("AssetLoader: Ready texture: "+r),t.onCompleteDownload(s)},d.src=e});t.queue.push(s)},t.loadTextureArray=function(e,r){var o=t.createLoader(function(){var n=new Image;W.images[r]={},W.images[r].image=n,n.onload=function(){var a=V.createTexture();W.images[r].imageId=a;var i=document.createElement("canvas");i.width=1024,i.height=1024;var s=i.getContext("2d");s.drawImage(n,0,0),V.activeTexture(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D_ARRAY,a),V.texParameteri(V.TEXTURE_2D_ARRAY,V.TEXTURE_MIN_FILTER,V.LINEAR_MIPMAP_LINEAR),V.texParameteri(V.TEXTURE_2D_ARRAY,V.TEXTURE_MAG_FILTER,V.LINEAR),V.texParameteri(V.TEXTURE_2D_ARRAY,V.TEXTURE_WRAP_S,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_2D_ARRAY,V.TEXTURE_WRAP_T,V.CLAMP_TO_EDGE);for(var d=new Uint8Array(4194304),u=0;u<16;u++)for(var c=0;c<16;c++)for(var l=16*u+c,f=s.getImageData(64*c,64*u,64,64),m=new Uint8Array(f.data.buffer),h=0;h<16384;h++)d[16384*l+h]=m[h];V.texImage3D(V.TEXTURE_2D_ARRAY,0,V.RGBA,64,64,256,0,V.RGBA,V.UNSIGNED_BYTE,d),V.generateMipmap(V.TEXTURE_2D_ARRAY),console.log("AssetLoader: Ready texture array: "+e),t.onCompleteDownload(o)},n.src=e});t.queue.push(o)},t.loadProtobufDefinition=function(e,r){var o=t.createLoader(function(){console.log("AssetLoader: starting protobuf "+e),protobuf.load(e,function(n,a){if(console.log("AssetLoader: loaded protobuf "+e),n)throw n;W.protoDefinition[r]=a.lookupType(r),t.onCompleteDownload(o)})});t.queue.push(o)},t.loadAudioAsset=function(e){},t.onCompleteDownload=function(r){for(var o=t.queue.length-1;o>=0;o--)t.queue[o].id==r.id&&t.queue.splice(o,1);t.queue.length<=0&&(console.log("AssetLoader: All Assets Loaded"),e())},t}function main(){O=document.getElementById("webcanvas"),k(),W.loader=_(B),W.loader.loadProtobufDefinition("proto/WebsocketProto.proto","Base"),W.loader.loadProtobufDefinition("proto/WebsocketGameProto.proto","GameBase"),W.loader.loadProtobufDefinition("proto/BlockShip.proto","Mass"),W.loader.loadTexture("images/astronaut.png","astronaut",V.NEAREST,V.NEAREST,!1,V.CLAMP_TO_EDGE),W.loader.loadTexture("images/ui.png","ui",V.NEAREST,V.NEAREST,!1,V.CLAMP_TO_EDGE),W.loader.loadTexture("images/font.png","font",V.NEAREST,V.NEAREST,!1,V.CLAMP_TO_EDGE),W.loader.loadTexture("images/fog.png","fog",V.NEAREST,V.NEAREST,!1,V.REPEAT),W.loader.loadTextureArray("images/blocks.png","blocks");var e=!1;if(W.debug){var t=W.account.getParameterByName("token"),r=W.account.getParameterByName("id");(e=null!=t&&null!=r)&&(W.account.token=t,W.account.playerId=parseInt(r))}e||(W.account.token=W.account.getCookie("token"),W.account.playerId=W.account.getCookie("playerId"),console.log("Cookie data "+W.account.token+" "+W.account.playerId)),W.shaders={},W.ui={},W.ui.stack=[],W.loader.loadAll()}function onSignIn(e){console.log("Got Google Sign In Callback"),W.account.googleUser=e;var t=W.account.googleUser.getBasicProfile();W.account.google=t;W.account.googleUser.getAuthResponse().id_token}function facebookStatusChangeCallback(e){console.log("FB statusChangeCallback:"),console.log(e)}function facebookCheckLoginState(){FB.getLoginStatus(function(e){facebookStatusChangeCallback(e)})}function B(){z=R(),Z=b(),W.gamepad=v(),(G=F()).setResolution(O.width,O.height),G.setOrthographicSize(G.minOrtho),G.transform.addPosition([0,0,-10]),(N=a(V,"shader-vs","shader-fs")).addAttribute("aVertexPosition"),N.enableVertexAttributeArray(N.getAttribute("aVertexPosition")),N.addUniform("uPMatrix"),N.addUniform("uMVMatrix"),(q=a(V,"skyboxVertexShader","skyboxFragmentShader")).addAttribute("coords"),q.enableVertexAttributeArray(q.getAttribute("coords")),q.addUniform("modelview"),q.addUniform("projection"),q.bufferMatrix("projection",G.projectionMatrix),G.shadersThatHasProjectionMatrix.push(q),(H=a(V,"quadVertexShader","quadFragmentShader")).addAttribute("vertexPosition"),H.addAttribute("textureCoordinates"),H.addUniform("colorMap"),H.addUniform("modelview"),H.addUniform("projection"),H.bufferMatrix("projection",G.projectionMatrix),G.shadersThatHasProjectionMatrix.push(H),W.shaders.quadOffsetVertexShader=a(V,"quadOffsetVertexShader","quadOffsetFragmentShader"),W.shaders.quadOffsetVertexShader.addAttribute("vertexPosition"),W.shaders.quadOffsetVertexShader.addAttribute("textureCoordinates"),W.shaders.quadOffsetVertexShader.addUniform("colorMap"),W.shaders.quadOffsetVertexShader.addUniform("modelview"),W.shaders.quadOffsetVertexShader.addUniform("projection"),W.shaders.quadOffsetVertexShader.addUniform("uvOffset"),W.shaders.quadOffsetVertexShader.bufferMatrix("projection",G.projectionMatrix),W.shaders.quadOffsetVertexShader.bufferVec2("uvOffset",[0,0]),G.shadersThatHasProjectionMatrix.push(W.shaders.quadOffsetVertexShader),(j=a(V,"blockVertexShader","blockFragmentShader")).addAttribute("vertexPosition"),j.addAttribute("textureCoordinates"),j.addUniform("modelview"),j.addUniform("projection"),j.addUniform("colorMap"),j.addUniform("blockMap"),j.addUniform("blockMapDimensions"),j.bufferMatrix("projection",G.projectionMatrix),G.shadersThatHasProjectionMatrix.push(j),W.shaders.points=a(V,"pointsVertexShader","pointsFragmentShader"),W.shaders.points.addAttribute("vertexPosition"),W.shaders.points.addAttribute("colorPosition"),W.shaders.points.addUniform("modelview"),W.shaders.points.addUniform("projection"),W.shaders.points.bufferMatrix("projection",G.projectionMatrix),G.shadersThatHasProjectionMatrix.push(W.shaders.points),W.shaders.lines=a(V,"linesVertexShader","linesFragmentShader"),W.shaders.lines.addAttribute("vertexPosition"),W.shaders.lines.addAttribute("colorPosition"),W.shaders.lines.addUniform("modelview"),W.shaders.lines.addUniform("projection"),W.shaders.lines.bufferMatrix("projection",G.projectionMatrix),G.shadersThatHasProjectionMatrix.push(W.shaders.lines),W.pointRenderer=m(),W.backgroundSprite=d(W.images.fog,256),W.ui.stack.push(n()),V.clearColor(0,0,0,0),V.disable(V.DEPTH_TEST),W.time={},W.time.fps=0,W.time.fpsCounter=0,W.time.targetFps=60,W.time.skipTicks=1e3/W.time.targetFps,W.time.deltaTime=0,W.time.maxFrameSkip=10,W.time.timeSinceStart=0,$=h(),window.onEachFrame(W.frame)}function k(){try{V=O.getContext("webgl2"),W.screen={},W.screen.fullscreen=!1,W.screen.width=O.width,W.screen.height=O.height,U(W.screen.width,W.screen.height),V.enable(V.BLEND),V.blendFunc(V.SRC_ALPHA,V.ONE_MINUS_SRC_ALPHA),console.log("WebGL loaded!")}catch(e){console.log("Could not get webgl")}V||alert("Could not initialise WebGL, sorry :-( ")}function U(e,t){console.log("New size "+e+" "+t),V.viewportWidth=e,V.viewportHeight=t,V.viewport(0,0,V.viewportWidth,V.viewportHeight)}function w(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){var e=O.clientWidth,t=O.clientHeight;O.width==e&&O.height==t||(O.width=e,O.height=t,U(O.width,O.height))}else O.width=W.screen.width,O.height=W.screen.height,U(W.screen.width,W.screen.height)}function toggleFullScreen(){document.addEventListener("fullscreenchange",w),document.addEventListener("webkitfullscreenchange",w),document.addEventListener("mozfullscreenchange",w),document.addEventListener("MSFullscreenChange",w),document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled?(W.screen.fullscreenWidth=O.clientWidth,W.screen.fullscreenHeight=O.clientHeight,document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():O.requestFullscreen?O.requestFullscreen():O.webkitRequestFullscreen?O.webkitRequestFullscreen():O.mozRequestFullScreen?O.mozRequestFullScreen():O.msRequestFullscreen&&O.msRequestFullscreen()):console.log("Cannot go Full Screen")}function I(){if(W.account.locallyAuthenticated)W.account.remotelyAuthenticated?(M(),L(),D()):W.account.backend&&(console.log("We are now authenticated with backend!"),W.account.remotelyAuthenticated=!0,W.ui.stack=[],W.ui.stack.push(o()));else{var e=!1;if(W.account.token?(console.log("We have stored token!"),W.account.locallyAuthenticated=!0,e=!0):W.account.google&&(console.log("We are now authenticated with google!"),W.account.locallyAuthenticated=!0,e=!0),e){var t="wss://84.211.52.237:443/websocket";W.debug&&(t="ws://localhost:8080/websocket"),W.socket=S(t,W.protoDefinition.Base)}}}function M(){W.gameSocket&&W.gameSocket.flush()}function L(){z.update(),Z.update(),W.gamepad.update()}function D(){W.hotspot&&W.hotspot.update()}function C(){V.clear(V.COLOR_BUFFER_BIT|V.DEPTH_BUFFER_BIT),W.hotspot&&W.hotspot.render();for(var e=0,t=W.ui.stack.length;e<t;e++)W.ui.stack[e].render();$.renderTextAtScreen("FPS: "+W.time.fps,!0,0,O.height-8,1)}console.log("Prepared shaders");var Y={},X={},V,O,W={};W.account={locallyAuthenticated:!1,remotelyAuthenticated:!1},W.debug=window.location.href.indexOf("localhost")>-1;var G,N,q,H,j,z,Z,K,Q,$;!function(){var e;window.requestAnimationFrame?(console.log("window.requestAnimationFrame"),e=function(e){var t=function(){e(),requestAnimationFrame(t)};t()}):window.webkitRequestAnimationFrame?(console.log("window.webkitRequestAnimationFrame"),e=function(e){var t=function(){e(),webkitRequestAnimationFrame(t)};t()}):window.mozRequestAnimationFrame?(console.log("window.mozRequestAnimationFrame"),e=function(e){var t=function(){e(),mozRequestAnimationFrame(t)};t()}):(console.log("setInterval"),e=function(e){setInterval(e,Game.skipTicks)}),window.onEachFrame=e}(),W.frame=function(){var e=0,t=Date.now(),r=Date.now();return function(){for(e=0;Date.now()>t&&e<W.time.maxFrameSkip;)W.time.deltaTime=.001*(t-r-W.time.timeSinceStart),Math.floor(.001*W.time.timeSinceStart)<Math.floor(.001*W.time.timeSinceStart+W.time.deltaTime)&&(W.time.fps=W.time.fpsCounter,W.time.fpsCounter=0),W.time.timeSinceStart=t-r,I(),W.time.fpsCounter++,t+=W.time.skipTicks,e++;C()}}(),W.account.setCookie=function(e,t,r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3);var n="expires="+o.toUTCString();document.cookie=e+"="+t+";"+n+";path=/"},W.account.eraseCookie=function(e){W.account.setCookie(e,"",0)},W.account.getCookie=function(e){for(var t=e+"=",r=document.cookie.split(";"),o=0;o<r.length;o++){for(var n=r[o];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""},W.account.getParameterByName=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null},W.getUiForType=function(e){for(var t=0,r=W.ui.stack.length;t<r;t++){var o=W.ui.stack[t];if(o.type==e)return o}return null};